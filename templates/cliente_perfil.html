{% extends "base.html" %}
{% from "macros/badges.html" import badge_negocio %}
{% block content %}

<div class="page-content">

  <div class="cliente-header" style="display:flex; gap:30px; align-items:center; flex-wrap:wrap; margin-bottom:30px;">

    <div class="cliente-avatar">
      {% if cliente.avatar_url %}
        <img src="{{ cliente.avatar_url }}" alt="Avatar" class="avatar-img">
      {% else %}
        <div class="avatar-placeholder">
          {{ cliente.nombre[0] }}{{ cliente.apellido[0] }}
        </div>
      {% endif %}
    </div>

    <div class="cliente-info" style="flex:1; display:grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap:12px;">
      <div><strong>Nombre:</strong> {{ cliente.nombre }} {{ cliente.apellido }}</div>
      <div><strong>Tel√©fono:</strong> {{ cliente.telefono or 'N/A' }}</div>
      <div><strong>Correo:</strong> {{ cliente.correo or 'N/A' }}</div>
      <div><strong>Direcci√≥n:</strong> {{ cliente.direccion or 'N/A' }}</div>
      <div><strong>Fecha registro:</strong> {{ cliente.fecha_registro_fmt }}</div>
      <div><strong>Total pedidos:</strong> {{ total_pedidos }}</div>
    </div>
  </div>

  <h2 style="margin-bottom:20px;">üì¶ Historial de pedidos</h2>

<form method="GET"
      action="{{ url_for('ver_cliente', id_cliente=cliente.id_cliente) }}"
      class="filtro-box">

  <div class="filtro-row">

    <div class="filtro-item">
      <label>Negocio</label>
      <select name="id_negocio">
        <option value="">Todos</option>
        {% for n in negocios %}
          <option value="{{ n.id_negocio }}"
            {% if request.args.get('id_negocio') == n.id_negocio|string %}
              selected
            {% endif %}
          >
            {{ n.nombre }}
          </option>
        {% endfor %}
      </select>
    </div>

    <div class="filtro-item">
      <label>Desde</label>
      <input
        type="date"
        name="fecha_inicio"
        value="{{ request.args.get('fecha_inicio', '') }}"
      >
    </div>

    <div class="filtro-item">
      <label>Hasta</label>
      <input
        type="date"
        name="fecha_fin"
        value="{{ request.args.get('fecha_fin', '') }}"
      >
    </div>

    <div class="filtro-actions">
      <button type="submit">Aplicar</button>

      {% if request.args.get('id_negocio') or request.args.get('fecha_inicio') or request.args.get('fecha_fin') %}
        <a href="{{ url_for('ver_cliente', id_cliente=cliente.id_cliente) }}">
          Limpiar
        </a>
      {% endif %}
    </div>

  </div>
</form>

  <div class="pedidos-container" style="display:flex; flex-direction:column; gap:20px;">

    {% for p in pedidos %}
      <div class="pedido-card" style="border-radius:16px; padding:20px; background:white; box-shadow:0 6px 16px rgba(0,0,0,0.08);">
        <p style="margin-top:4px; display:flex; align-items:center; gap:8px;">
          {{ badge_negocio(p.negocio) }}
        </p>
        
        <p style="font-weight:600; color:#1e3a8a;">
          Fecha: {{ p.fecha_recibo.strftime('%d/%m/%Y') }}
        </p>

        <p style="margin-top:4px;">
          <strong style="color:#1e3a8a;">Status:</strong>
          {% if p.fecha_entrega %}
            <span class="status status-completado">‚úî Completado</span>
          {% else %}
            <span class="status status-pendiente">‚è≥ Pendiente</span>
          {% endif %}
        </p>

        <table style="width:100%; margin-top:12px; border-collapse:collapse;">
          <thead>
            <tr style="background:#e6f3ff; color:#1e3a8a;">
              <th style="padding:8px; text-align:left;">Art√≠culo</th>
              <th style="padding:8px; text-align:left;">Servicios</th>
              <th style="padding:8px; text-align:left;">Subtotal</th>
            </tr>
          </thead>

          <tbody>
            {% for item in p.detalles %}
              <tr style="border-top:1px solid #eee; vertical-align:top;">

                <td style="padding:8px; width:45%;">
                  {% if item.tipo_articulo == "calzado" %}
                    üëü {{ item.datos.tipo }} {{ item.datos.marca }}
                    <div style="opacity:0.8; margin-top:2px;">
                      {{ item.datos.color_base }}
                      {% if item.datos.color_secundario %}/{{ item.datos.color_secundario }}{% endif %}
                    </div>

                  {% elif item.tipo_articulo == "confeccion" %}
                    üßµ {{ item.datos.tipo }}
                    {% if item.datos.marca %} {{ item.datos.marca }}{% endif %}
                    <div style="opacity:0.8; margin-top:2px;">
                      Cantidad: <b>{{ item.datos.cantidad }}</b>
                    </div>

                  {% elif item.tipo_articulo == "maquila" %}
                    üè≠ {{ item.datos.tipo }}
                    <div style="opacity:0.8; margin-top:2px;">
                      Cantidad: <b>{{ item.datos.cantidad }}</b><br>
                      Precio unitario: <b>${{ "{:.2f}".format(item.datos.precio_unitario) }}</b>
                    </div>
                  {% endif %}

                  {% if item.comentario %}
                    <div style="
                      margin-top:6px;
                      font-style:italic;
                      opacity:0.85;
                      white-space:normal;
                      word-break:break-word;
                      overflow-wrap:anywhere;
                    ">
                      üí¨ {{ item.comentario }}
                    </div>
                  {% endif %}
                </td>

                <td style="padding:8px; width:35%;">
                  {% if item.servicios and item.servicios|length > 0 %}
                    <div style="display:flex; flex-direction:column; gap:6px;">
                      {% for s in item.servicios %}
                        <div>{{ s.nombre }}</div>
                      {% endfor %}
                    </div>
                  {% else %}
                    <span style="opacity:0.7;">Sin servicios</span>
                  {% endif %}
                </td>

                <td style="padding:8px; width:20%;">
                  {% set ns = namespace(subtotal=0) %}

                  {% if item.tipo_articulo == "maquila" %}
                    {% set ns.subtotal = (item.datos.cantidad | float(0)) * (item.datos.precio_unitario | float(0)) %}
                  {% else %}
                    {% for s in item.servicios %}
                      {% set ns.subtotal = ns.subtotal + (s.precio_aplicado | float(0)) %}
                    {% endfor %}
                  {% endif %}

                  <b>${{ "{:.2f}".format(ns.subtotal) }}</b>
                </td>

              </tr>
            {% endfor %}
          </tbody>
        </table>

        {% set descuento = (p.cantidad_descuento | float(0)) %}

        <p style="margin-top:12px;">
          <strong style="color:#1e3a8a;">Total:</strong>
          ${{ "{:.2f}".format(p.total) }}

          {% if descuento > 0 %}
            <span style="margin-left:6px; font-weight:600; color:#1e3a8a;">
              (-${{ "{:.2f}".format(descuento) }}) Descuento
            </span>
          {% endif %}
        </p>


        <p style="margin-top:8px;">
          <strong style="color:#1e3a8a;">Pagado:</strong>
          ${{ "{:.2f}".format(p.total_pagado) }}
        </p>

        {% if p.saldo_pendiente > 0 %}
          <p>
            <strong style="color:#b91c1c;">Saldo pendiente:</strong>
            ${{ "{:.2f}".format(p.saldo_pendiente) }}
          </p>
        {% else %}
          <p style="color:#15803d; font-weight:600;">
            ‚úî Pedido liquidado
          </p>
        {% endif %}

        {% if p.pagos and p.pagos|length > 0 %}
          <div style="margin-top:12px;">
            <strong style="color:#1e3a8a;">Pagos realizados</strong>

            <ul style="margin-top:6px; padding-left:18px;">
              {% for pago in p.pagos %}
                <li style="margin-bottom:4px;">
                  <b>{{ pago.tipo_pago_venta | capitalize }}</b>
                  ‚Äî {{ pago.tipo_pago | capitalize }}
                  ‚Äî <b>${{ "{:.2f}".format(pago.monto) }}</b>
                </li>
              {% endfor %}
            </ul>
          </div>
        {% else %}
          <p style="opacity:0.7; margin-top:8px;">
            Sin pagos registrados
          </p>
        {% endif %}

      </div>

    {% else %}
      <div class="empty-state">
        <div class="empty-icon">üì¶</div>

        <h3>Sin pedidos registrados</h3>

        <p>
          Este cliente a√∫n no tiene pedidos.<br>
          Cuando se registre alguno, se mostrar√° aqu√≠.
        </p>
      </div>
    {% endfor %}


  </div>

  <div class="paginacion">
    {% if total_paginas > 1 %}
        {% set bloque = ((pagina - 1) // 10) %}
        {% set inicio = bloque * 10 + 1 %}
        {% set fin = inicio + 9 %}
        {% if fin > total_paginas %}
            {% set fin = total_paginas %}
        {% endif %}

        {% if inicio > 1 %}
            <a href="{{ url_for('ver_cliente', id_cliente=cliente.id_cliente, pagina=p, id_negocio=request.args.get('id_negocio'), fecha_inicio=request.args.get('fecha_inicio'), fecha_fin=request.args.get('fecha_fin')) }}">¬´</a>
        {% endif %}

        {% for p in range(inicio, fin + 1) %}
            {% if p == pagina %}
                <strong>{{ p }}</strong>
            {% else %}
              <a href="{{ url_for('ver_cliente', id_cliente=cliente.id_cliente, pagina=p, id_negocio=request.args.get('id_negocio'), fecha_inicio=request.args.get('fecha_inicio'), fecha_fin=request.args.get('fecha_fin')) }}">¬´</a>
            {% endif %}
        {% endfor %}

        {% if fin < total_paginas %}
          <a href="{{ url_for('ver_cliente', id_cliente=cliente.id_cliente, pagina=p, id_negocio=request.args.get('id_negocio'), fecha_inicio=request.args.get('fecha_inicio'), fecha_fin=request.args.get('fecha_fin')) }}">¬´</a>
        {% endif %}
    {% endif %}
  </div>

</div>

{% endblock %}
