{% extends "base.html" %}

{% block content %}

{% from "components/alerts.html" import alerts %}
{% from "components/pagination.html" import pagination %}
{% from "components/table.html" import table %}
{% from "components/modal.html" import modal %}


<h1>ðŸ‘¥ Clientes</h1>

{{ alerts(get_flashed_messages(with_categories=true)) }}

<form method="GET" action="/clientes" class="search-bar">
    <input 
        type="text" 
        name="q" 
        placeholder="Buscar cliente por nombre o apellido"
        value="{{ q or '' }}"
    >
    <button type="submit" class="btn btn--primary btn--sm">
        Buscar
    </button>

</form>

<form method="GET" action="{{ url_for('clientes.clientes') }}" class="filtro-toggle">

    <input type="hidden" name="q" value="{{ q or '' }}">

    <label class="switch">
        <input type="checkbox"
               name="eliminados"
               value="1"
               onchange="this.form.submit()"
               {% if incluir_eliminados %}checked{% endif %}>
        <span class="slider"></span>
    </label>

    <span class="toggle-text">Mostrar eliminados</span>
</form>


<button onclick="abrirModal('modalCliente')" class="btn btn--primary">
    âž• Agregar cliente
</button>


{% call(section) modal("modalCliente", "Agregar cliente", "md") %}

{% if section == 'body' %}
<form id="modalClienteForm" method="POST" action="/clientes/guardar" class="modal-form">
  <input type="hidden" name="id_cliente" id="id_cliente">

  <div class="modal-field">
    <label for="cliente_nombre">Nombre</label>
    <input id="cliente_nombre" type="text" name="nombre" required>
  </div>

  <div class="modal-field">
    <label for="cliente_apellido">Apellido</label>
    <input id="cliente_apellido" type="text" name="apellido" required>
  </div>

  <div class="modal-field">
    <label for="cliente_telefono">TelÃ©fono</label>
    <input id="cliente_telefono"
           type="text"
           name="telefono"
           required
           pattern="[0-9]{10}">
  </div>

  <div class="modal-field">
    <label for="cliente_correo">Correo (opcional)</label>
    <input id="cliente_correo" type="email" name="correo">
  </div>

  <div class="modal-field">
    <label for="cliente_direccion">CÃ³digo Postal (opcional)</label>
    <input id="cliente_direccion" type="text" name="direccion">
  </div>

</form>
{% endif %}


{% if section == 'footer' %}
<button type="button"
        class="btn btn--danger btn--sm"
        onclick="cerrarModal('modalCliente')">
  Cancelar
</button>

<button type="submit"
        form="modalClienteForm"
        class="btn btn--primary btn--lg">
  Guardar cliente
</button>
{% endif %}

{% endcall %}




<hr>


{% call table([
    "Nombre",
    "TelÃ©fono",
    "Estado",
    "Acciones"
]) %}

    {% for c in clientes %}
    <tr
        data-href="{{ url_for('clientes.ver_cliente', id_cliente=c.id_cliente) }}"
        class="clickable-row"
    >

        <td>{{ c.nombre }} {{ c.apellido }}</td>

        <td>{{ c.telefono }}</td>

        <td>
            {% if c.activo %}
                <span class="status status-completado">Activo</span>
            {% else %}
                <span class="status status-pendiente">Eliminado</span>
            {% endif %}
        </td>

        <td>
        {% if c.activo %}

            <button type="button"
                class="btn btn--success btn--sm no-row-click"
                data-id="{{ c.id_cliente }}"
                data-nombre="{{ c.nombre }}"
                data-apellido="{{ c.apellido }}"
                data-correo="{{ c.correo or '' }}"
                data-telefono="{{ c.telefono }}"
                data-direccion="{{ c.direccion or '' }}"
                onclick="editarClienteBtn(event, this)">
                Editar
            </button>

            <button type="button"
                    class="btn btn--info btn--sm no-row-click"
                    onclick="verHistorialCliente(event, {{ c.id_cliente }})">
                Historial
            </button>

            <button type="button"
                    class="btn btn--danger btn--sm no-row-click"
                    onclick="confirmarEliminarCliente({{ c.id_cliente }})">
                Eliminar
            </button>

        {% else %}

            <button type="button"
                    class="btn btn--primary btn--sm no-row-click"
                    onclick="restaurarCliente({{ c.id_cliente }})">
                Restaurar
            </button>

        {% endif %}
        </td>
    </tr>
    {% endfor %}

{% endcall %}



{% call(section) modal("modalHistorialCliente", "Historial del cliente", "lg") %}

{% if section == 'body' %}
<table id="tablaHistorialCliente"
       class="table table--striped table--hover">
  <thead>
    <tr>
      <th>AcciÃ³n</th>
      <th>Usuario</th>
      <th>Fecha</th>
      <th>Cambios</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>
{% endif %}

{% endcall %}



{% from "components/pagination.html" import pagination %}

{{ pagination(
    pagina,
    total_paginas,
    'clientes.clientes',
    {
      "q": q,
      "eliminados": request.args.get('eliminados')
    }
) }}

{% endblock %}

{% block scripts %}
  <script src="{{ url_for('static', filename='js/modal.js') }}"></script>
  <script src="{{ url_for('static', filename='js/clientes.js') }}"></script>
{% endblock %}


