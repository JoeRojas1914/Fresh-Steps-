{% extends "base.html" %}

{% block content %}
<h1>üë• Clientes</h1>

{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    {% for category, message in messages %}
      <div class="alert {{ category }}">
        {{ message }}
      </div>
    {% endfor %}
  {% endif %}
{% endwith %}

<form method="GET" action="/clientes" class="search-bar">
    <input 
        type="text" 
        name="q" 
        placeholder="Buscar cliente por nombre o apellido"
        value="{{ q or '' }}"
    >
    <button type="submit">Buscar</button>
</form>

<form method="GET" action="{{ url_for('clientes.clientes') }}" class="filtro-toggle">

    <input type="hidden" name="q" value="{{ q or '' }}">

    <label class="switch">
        <input type="checkbox"
               name="eliminados"
               value="1"
               onchange="this.form.submit()"
               {% if incluir_eliminados %}checked{% endif %}>
        <span class="slider"></span>
    </label>

    <span class="toggle-text">Mostrar eliminados</span>
</form>


<button onclick="abrirModal()">‚ûï Agregar cliente</button>


<div id="modal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="cerrarModal()">&times;</span>

        <h2 id="modalTitulo">Agregar cliente</h2>

        <form method="POST" action="/clientes/guardar" class="modal-form">
            <input type="hidden" name="id_cliente" id="id_cliente">

            <div class="modal-field">
                <label for="cliente_nombre">Nombre</label>
                <input id="cliente_nombre" type="text" name="nombre" required>
            </div>

            <div class="modal-field">
                <label for="cliente_apellido">Apellido</label>
                <input id="cliente_apellido" type="text" name="apellido" required>
            </div>

            <div class="modal-field">
                <label for="cliente_telefono">Tel√©fono</label>
                <input id="cliente_telefono" type="text" name="telefono" required pattern="[0-9]{10}" title="Debe contener 10 d√≠gitos">
            </div>

            <div class="modal-field">
                <label for="cliente_correo">Correo (opcional)</label>
                <input id="cliente_correo" type="email" name="correo">
            </div>

            <div class="modal-field">
                <label for="cliente_direccion">Codigo Postal (opcional)</label>
                <input id="cliente_direccion" type="text" name="direccion">
            </div>

            <button type="submit" class="btn-guardar-modal">
                Guardar cliente
            </button>
        </form>

    </div>
</div>

<hr>


<table>
    <thead>
        <tr>
            <th>Nombre</th>
            <th>Tel√©fono</th>
            <th>Estado</th>
            <th>Acciones</th>
        </tr>
    </thead>
    <tbody>
        {% for c in clientes %}
        <tr onclick="window.location.href='/clientes/{{ c.id_cliente }}'" style="cursor:pointer;">

            <td>{{ c.nombre }} {{ c.apellido }}</td>

            <td>{{ c.telefono }}</td>

            <td>
                {% if c.activo %}
                    <span class="status status-completado">Activo</span>
                {% else %}
                    <span class="status status-pendiente">Eliminado</span>
                {% endif %}
            </td>

            <td>

                {% if c.activo %}

                    <button type="button" class="btn-edit"
                        onclick='editarCliente(event, {{ c.id_cliente }}, {{ c.nombre|tojson }}, {{ c.apellido|tojson }}, {{ c.correo|tojson }}, {{ c.telefono|tojson }}, {{ c.direccion|tojson }})'>
                        Editar
                    </button>

                    <button type="button"
                            class="btn-info"
                            onclick="verHistorialCliente(event, {{ c.id_cliente }})">
                        Historial
                    </button>

                    <a href="/clientes/eliminar/{{ c.id_cliente }}"
                    class="btn-delete"
                    onclick="return confirm('¬øSeguro que desea desactivar al cliente?')">
                        Eliminar
                    </a>

                {% else %}
                    <a href="/clientes/restaurar/{{ c.id_cliente }}"
                    class="btn-edit"
                    style="background:linear-gradient(to right,#3b82f6,#2563eb);">
                        Restaurar
                    </a>

                {% endif %}
            </td>
        </tr>

        {% endfor %}
    </tbody>
</table>

<div id="modalHistorialCliente" class="modal">
  <div class="modal-content" style="width:750px; max-width:95vw;">
    <span class="close" onclick="cerrarHistorialCliente()">&times;</span>

    <h2>Historial del cliente</h2>

    <table id="tablaHistorialCliente">
      <thead>
        <tr>
          <th>Acci√≥n</th>
          <th>Usuario</th>
          <th>Fecha</th>
          <th>Cambios</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>


<div class="paginacion">
    {% if total_paginas > 1 %}

        {% set bloque = ((pagina - 1) // 10) %}
        {% set inicio = bloque * 10 + 1 %}
        {% set fin = inicio + 9 %}
        {% if fin > total_paginas %}
            {% set fin = total_paginas %}
        {% endif %}

        {% if inicio > 1 %}
            <a href="{{ url_for('clientes.clientes', pagina=inicio-10, q=q) }}">¬´</a>
        {% endif %}

        {% for p in range(inicio, fin + 1) %}
            {% if p == pagina %}
                <strong>{{ p }}</strong>
            {% else %}
                <a href="{{ url_for('clientes.clientes', pagina=p, q=q) }}">{{ p }}</a>
            {% endif %}
        {% endfor %}

        {% if fin < total_paginas %}
            <a href="{{ url_for('clientes.clientes', pagina=inicio+10, q=q) }}">¬ª</a>
        {% endif %}

    {% endif %}
</div>



<script>
    document.querySelector(".modal-form").addEventListener("submit", function(e) {
        const nombre = document.querySelector("[name=nombre]").value.trim();
        const apellido = document.querySelector("[name=apellido]").value.trim();
        const telefono = document.querySelector("[name=telefono]").value.trim();

        if (!nombre || !apellido || !telefono) {
            alert("‚ö†Ô∏è Nombre, apellido y tel√©fono son obligatorios.");
            e.preventDefault();
            return;
        }

        if (!/^\d{10}$/.test(telefono)) {
            alert("üì± El tel√©fono debe tener exactamente 10 d√≠gitos.");
            e.preventDefault();
        }
    });

    function abrirModal() {
        document.getElementById("modal").style.display = "block";
        document.getElementById("modalTitulo").innerText = "Agregar cliente";
        document.getElementById("id_cliente").value = "";
    }

    function cerrarModal() {
        document.getElementById("modal").style.display = "none";
    }

    function editarCliente(e, id, nombre, apellido, correo, telefono, direccion) {
        e.stopPropagation(); 
        abrirModal();
        document.getElementById("modalTitulo").innerText = "Editar cliente";

        document.getElementById("id_cliente").value = id;
        document.querySelector("[name=nombre]").value = nombre;
        document.querySelector("[name=apellido]").value = apellido;
        document.querySelector("[name=correo]").value = correo;
        document.querySelector("[name=telefono]").value = telefono;
        document.querySelector("[name=direccion]").value = direccion;
    }


    function cerrarHistorialCliente() {
        document.getElementById("modalHistorialCliente").style.display = "none";
    }

    async function verHistorialCliente(e, id) {

        e.stopPropagation(); // evita que abra el perfil

        const modal = document.getElementById("modalHistorialCliente");
        const tbody = document.querySelector("#tablaHistorialCliente tbody");

        tbody.innerHTML = "<tr><td colspan='4'>Cargando...</td></tr>";
        modal.style.display = "block";

        const res = await fetch(`/clientes/${id}/historial`);
        const data = await res.json();

        if (!data.length) {
            tbody.innerHTML = "<tr><td colspan='4'>Sin historial</td></tr>";
            return;
        }

        tbody.innerHTML = "";

        data.forEach(h => {

            const antes = h.datos_antes ? JSON.parse(h.datos_antes) : null;
            const despues = h.datos_despues ? JSON.parse(h.datos_despues) : null;

            let cambios = "";

            if (h.accion === "RESTAURADO") {
                cambios = "<span>Cliente restaurado</span>";

            } else if (antes && despues) {

                Object.keys(despues).forEach(k => {
                    if (antes[k] !== despues[k]) {
                        cambios += `
                            <div>
                                <b>${k}</b>:
                                <span style="color:#ef4444">${antes[k]}</span>
                                ‚Üí
                                <span style="color:#22c55e">${despues[k]}</span>
                            </div>
                        `;
                    }
                });

            } else if (despues) {
                cambios = "Cliente creado";
            } else {
                cambios = "Cliente eliminado";
            }

            tbody.innerHTML += `
                <tr>
                    <td><b>${h.accion}</b></td>
                    <td>${h.usuario}</td>
                    <td>${new Date(h.fecha).toLocaleString()}</td>
                    <td>${cambios}</td>
                </tr>
            `;
        });
    }

    </script>
    
{% endblock %}
