{% extends "base.html" %}

{% block content %}
<h1>ðŸ‘¥ Clientes</h1>

{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    {% for category, message in messages %}
      <div class="alert {{ category }}">
        {{ message }}
      </div>
    {% endfor %}
  {% endif %}
{% endwith %}

<form method="GET" action="/clientes" class="search-bar">
    <input 
        type="text" 
        name="q" 
        placeholder="Buscar cliente por nombre o apellido"
        value="{{ q or '' }}"
    >
    <button type="submit">Buscar</button>
</form>


<button onclick="abrirModal()">âž• Agregar cliente</button>


<div id="modal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="cerrarModal()">&times;</span>

        <h2 id="modalTitulo">Agregar cliente</h2>

        <form method="POST" action="/clientes/guardar">
            <input type="hidden" name="id_cliente" id="id_cliente">

            <input type="text" name="nombre" placeholder="Nombre" required>
            <input type="text" name="apellido" placeholder="Apellido" required>
            <input type="email" name="correo" placeholder="Correo">
            <input type="text" name="telefono" placeholder="TelÃ©fono">
            <input type="text" name="direccion" placeholder="DirecciÃ³n">

            <button type="submit">Guardar</button>
        </form>
    </div>
</div>

<hr>


<table border="1">
    <thead>
        <tr>
            <th>Nombre</th>
            <th>Correo</th>
            <th>TelÃ©fono</th>
            <th>Acciones</th>
        </tr>
    </thead>
    <tbody>
        {% for c in clientes %}
        <tr onclick="window.location.href='/clientes/{{ c.id_cliente }}'" style="cursor:pointer;">
            <td>{{ c.nombre }} {{ c.apellido }}</td>
            <td>{{ c.correo }}</td>
            <td>{{ c.telefono }}</td>
            <td>
                <button class="btn-edit"
                    onclick='editarCliente({{ c.id_cliente }},{{ c.nombre|tojson }}, {{ c.apellido|tojson }}, {{ c.correo|tojson }}, {{ c.telefono|tojson }}, {{ c.direccion|tojson }})'>
                    Edit
                </button>

                <a href="/clientes/eliminar/{{ c.id_cliente }}" class="btn-delete" onclick="return confirm('Â¿Seguro que desea eliminar al cliente?')">
                    Delete
                </a>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<div class="paginacion">
    {% if total_paginas > 1 %}

        {% set bloque = ((pagina - 1) // 10) %}
        {% set inicio = bloque * 10 + 1 %}
        {% set fin = inicio + 9 %}
        {% if fin > total_paginas %}
            {% set fin = total_paginas %}
        {% endif %}

        {% if inicio > 1 %}
            <a href="{{ url_for('clientes', pagina=inicio-10, q=q) }}">Â«</a>
        {% endif %}

        {% for p in range(inicio, fin + 1) %}
            {% if p == pagina %}
                <strong>{{ p }}</strong>
            {% else %}
                <a href="{{ url_for('clientes', pagina=p, q=q) }}">{{ p }}</a>
            {% endif %}
        {% endfor %}

        {% if fin < total_paginas %}
            <a href="{{ url_for('clientes', pagina=inicio+10, q=q) }}">Â»</a>
        {% endif %}

    {% endif %}
</div>



<script>
    function abrirModal() {
        document.getElementById("modal").style.display = "block";
        document.getElementById("modalTitulo").innerText = "Agregar cliente";
        document.getElementById("id_cliente").value = "";
    }

    function cerrarModal() {
        document.getElementById("modal").style.display = "none";
    }

    function editarCliente(id, nombre, apellido, correo, telefono, direccion) {
        abrirModal();
        document.getElementById("modalTitulo").innerText = "Editar cliente";

        document.getElementById("id_cliente").value = id;
        document.querySelector("[name=nombre]").value = nombre;
        document.querySelector("[name=apellido]").value = apellido;
        document.querySelector("[name=correo]").value = correo;
        document.querySelector("[name=telefono]").value = telefono;
        document.querySelector("[name=direccion]").value = direccion;
    }
    </script>
    
{% endblock %}
