{% extends "base.html" %}

{% block content %}
<div class="dashboard-header">
    <h1>游늵 Estad칤sticas</h1>
</div>

<div class="summary-cards">

    <div class="summary-card kpi-card clientes">
        <div class="kpi-icon">游논</div>
        <h3>Total de clientes</h3>
        <div class="card-number">{{ total_clientes }}</div>
        <span class="kpi-sub">Registrados</span>
    </div>

    <div class="summary-card kpi-card services">
        <div class="kpi-icon">游빞</div>
        <h3>Total de servicios</h3>
        <div class="card-number">{{ total_servicios }}</div>
        <span class="kpi-sub">Registrados</span>
    </div>

</div>

<div class="monthly-cards">

    <div class="monthly-card ventas">
        <h4>游눯 Ventas del mes</h4>
        <p id="ventasMes">$0</p>
    </div>

    <div class="monthly-card gastos">
        <h4>游눶 Gastos del mes</h4>
        <p id="gastosMes">$0</p>
    </div>

    <div class="monthly-card ganancia">
        <h4>游늳 Ganancia del mes</h4>
        <p id="gananciaMes">$0</p>
    </div>

</div>



<div class="stats-page">

<!-- ================= GASTOS ================= -->
<div class="card stats-card">
    <h2 class="stats-title">Gastos</h2>

    <form class="month-form" onsubmit="return false;">
        <label>A침o:</label>
        <select id="a침o_gastos"></select>

        <label>Mes:</label>
        <select id="mes_gastos"></select>
    </form>

    <canvas id="gastosChart"></canvas>
</div>

<!-- ================= GANANCIAS ================= -->
<div class="card stats-card">
    <h2 class="stats-title">Ganancias por semana</h2>

    <form class="month-form" onsubmit="return false;">
        <label>A침o:</label>
        <select id="a침o_ganancias"></select>

        <label>Mes:</label>
        <select id="mes_ganancias"></select>
    </form>

    <canvas id="gananciasChart"></canvas>
</div>

</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
let gastosChart;
let gananciasChart;

const nombresMeses = [
    "", "Enero","Febrero","Marzo","Abril","Mayo","Junio",
    "Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"
];

const redPalette = [
    "#b91c1c",
    "#dc2626",
    "#ef4444",
    "#f87171",
    "#fca5a5",
    "#fecaca",
    "#fee2e2",
];

document.addEventListener("DOMContentLoaded", async () => {
    initCharts();
    await cargarA침os();
});

function initCharts() {

    gastosChart = new Chart(document.getElementById("gastosChart"), {
        type: "pie",
        data: {
            labels: [],
            datasets: [{
                data: [],
                backgroundColor: []
            }]
        }
    });

    gananciasChart = new Chart(document.getElementById("gananciasChart"), {
        type: "bar",
        data: {
            labels: [],
            datasets: [{
                label: "Ganancias ($)",
                data: [],
                backgroundColor: "#22c55e",
                hoverBackgroundColor: "#16a34a",
                borderRadius: 8
            }]
        },
        options: {
            scales: {
                y: { beginAtZero: true }
            }
        }
    });
}

async function cargarA침os() {
    const a침osGastos = await fetchJSON("/api/estadisticas/gastos/a침os");
    const a침osGanancias = await fetchJSON("/api/estadisticas/ganancias/a침os");

    llenarSelect("a침o_gastos", a침osGastos);
    llenarSelect("a침o_ganancias", a침osGanancias);

    await cargarMesesGastos();
    await cargarMesesGanancias();
}

async function cargarMesesGastos() {
    const a침o = a침o_gastos.value;
    const meses = await fetchJSON(`/api/estadisticas/gastos/meses?a침o=${a침o}`);
    llenarSelect("mes_gastos", meses, true);
    cargarGastos();
}

async function cargarMesesGanancias() {
    const a침o = a침o_ganancias.value;

    const meses = await fetchJSON(
        `/api/estadisticas/ganancias/meses?a침o=${a침o}`
    );

    llenarSelect("mes_ganancias", meses, true);

    cargarGanancias();
    cargarTotalesMes(); 
}


function cargarGastos() {
    fetch(`/api/estadisticas/gastos?mes=${mes_gastos.value}&a침o=${a침o_gastos.value}`)
        .then(r => r.json())
        .then(data => {
            gastosChart.data.labels = data.labels;
            gastosChart.data.datasets[0].data = data.data;
            gastosChart.data.datasets[0].backgroundColor =
                data.labels.map((_, i) => redPalette[i % redPalette.length]);
            gastosChart.update();
        });
}

function cargarGanancias() {
    const a침o = document.getElementById("a침o_ganancias").value;
    const mes = document.getElementById("mes_ganancias").value;

    fetch(`/api/estadisticas/ganancias?mes=${mes}&a침o=${a침o}`)
        .then(r => r.json())
        .then(data => {
            gananciasChart.data.labels = data.rangos;
            gananciasChart.data.datasets[0].data = data.totales;
            gananciasChart.update();
        });
}

function cargarTotalesMes() {
    const a침o = document.getElementById("a침o_ganancias").value;
    const mes = document.getElementById("mes_ganancias").value;

    if (!a침o || !mes) return;

    fetch(`/api/estadisticas/totales-mes?mes=${mes}&a침o=${a침o}`)
        .then(r => r.json())
        .then(data => {
            document.getElementById("ventasMes").textContent =
                `$${Number(data.ventas).toLocaleString()}`;

            document.getElementById("gastosMes").textContent =
                `$${Number(data.gastos).toLocaleString()}`;

            document.getElementById("gananciaMes").textContent =
                `$${Number(data.ganancia).toLocaleString()}`;
        })
        .catch(err => console.error("Error totales mes:", err));
}


function llenarSelect(id, valores, esMes=false) {
    const select = document.getElementById(id);
    select.innerHTML = "";
    valores.forEach(v => {
        const opt = document.createElement("option");
        opt.value = v;
        opt.text = esMes ? nombresMeses[v] : v;
        select.appendChild(opt);
    });
}

async function fetchJSON(url) {
    const res = await fetch(url);
    return res.json();
}

a침o_gastos.onchange = cargarMesesGastos;
mes_gastos.onchange = cargarGastos;

a침o_ganancias.onchange = cargarMesesGanancias;
mes_ganancias.onchange = () => {
    cargarGanancias();
    cargarTotalesMes();
};
</script>


{% endblock %}
