{% extends "base.html" %}

{% block content %}
<div class="dashboard-header">
    <h1>游늵 Estad칤sticas</h1>
</div>

<div class="summary-cards">

    <div class="summary-card kpi-card clientes">
        <div class="kpi-icon">游논</div>
        <h3>Total de clientes</h3>
        <div class="card-number">{{ total_clientes }}</div>
        <span class="kpi-sub">Registrados</span>
    </div>

    <div class="summary-card kpi-card services">
        <div class="kpi-icon">游빞</div>
        <h3>Total de servicios</h3>
        <div class="card-number">{{ total_servicios }}</div>
        <span class="kpi-sub">Registrados</span>
    </div>

</div>

<!-- ================= SELECTOR GENERAL DE FECHA ================= -->
<div class="date-selector" style="margin: 20px 0;">
    <form onsubmit="return false;" style="display:flex; gap:15px; align-items:center;">
        <label>A침o:</label>
        <select id="a침o_general"></select>

        <label>Mes:</label>
        <select id="mes_general"></select>
    </form>
</div>

<!-- ================= MONTHLY CARDS ================= -->
<div class="monthly-cards">
    <div class="monthly-card ventas">
        <h4>游눯 Ventas del mes</h4>
        <p id="ventasMes">$0</p>
    </div>

    <div class="monthly-card gastos">
        <h4>游눶 Gastos del mes</h4>
        <p id="gastosMes">$0</p>
    </div>

    <div class="monthly-card ganancia">
        <h4>游늳 Ganancia del mes</h4>
        <p id="gananciaMes">$0</p>
    </div>
</div>

<!-- ================= GR츼FICAS ================= -->
<div class="stats-page">
    <!-- GASTOS -->
    <div class="card stats-card">
        <h2 class="stats-title">Gastos</h2>
        <canvas id="gastosChart"></canvas>
    </div>

    <!-- GANANCIAS -->
    <div class="card stats-card">
        <h2 class="stats-title">Ganancias por semana</h2>
        <canvas id="gananciasChart"></canvas>
    </div>
</div>

<!-- ================= CHART.JS ================= -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
let gastosChart;
let gananciasChart;

const nombresMeses = [
    "", "Enero","Febrero","Marzo","Abril","Mayo","Junio",
    "Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"
];

const redPalette = [
    "#b91c1c", "#dc2626", "#ef4444", "#f87171", "#fca5a5", "#fecaca", "#fee2e2",
];

document.addEventListener("DOMContentLoaded", async () => {
    initCharts();
    await cargarA침os();
    await cargarMeses();
    cargarTodasLasGraficas();
});

function initCharts() {
    gastosChart = new Chart(document.getElementById("gastosChart"), {
        type: "pie",
        data: { labels: [], datasets: [{ data: [], backgroundColor: [] }] }
    });

    gananciasChart = new Chart(document.getElementById("gananciasChart"), {
        type: "bar",
        data: {
            labels: [],
            datasets: [{
                label: "Ganancias ($)",
                data: [],
                backgroundColor: "#22c55e",
                hoverBackgroundColor: "#16a34a",
                borderRadius: 8
            }]
        },
        options: {
            scales: { y: { beginAtZero: true } }
        }
    });
}

// ================= FUNCIONES DE CARGA =================
async function cargarA침os() {
    const a침osGastos = await fetchJSON("/api/estadisticas/gastos/a침os");
    const a침osGanancias = await fetchJSON("/api/estadisticas/ganancias/a침os");
    const a침os = Array.from(new Set([...a침osGastos, ...a침osGanancias])); // unificar
    llenarSelect("a침o_general", a침os);
}

async function cargarMeses() {
    const a침o = document.getElementById("a침o_general").value;

    const mesesGastos = await fetchJSON(`/api/estadisticas/gastos/meses?a침o=${a침o}`);
    const mesesGanancias = await fetchJSON(`/api/estadisticas/ganancias/meses?a침o=${a침o}`);
    const meses = Array.from(new Set([...mesesGastos, ...mesesGanancias]));

    llenarSelect("mes_general", meses, true);
}

function cargarTodasLasGraficas() {
    const mes = document.getElementById("mes_general").value;
    const a침o = document.getElementById("a침o_general").value;

    if (!mes || !a침o) return;

    // Cargar gastos
    fetch(`/api/estadisticas/gastos?mes=${mes}&a침o=${a침o}`)
        .then(r => r.json())
        .then(data => {
            gastosChart.data.labels = data.labels;
            gastosChart.data.datasets[0].data = data.data;
            gastosChart.data.datasets[0].backgroundColor =
                data.labels.map((_, i) => redPalette[i % redPalette.length]);
            gastosChart.update();
        });

    // Cargar ganancias
    fetch(`/api/estadisticas/ganancias?mes=${mes}&a침o=${a침o}`)
        .then(r => r.json())
        .then(data => {
            gananciasChart.data.labels = data.rangos;
            gananciasChart.data.datasets[0].data = data.totales;
            gananciasChart.update();
        });

    // Cargar monthly cards y totales
    fetch(`/api/estadisticas/totales-mes?mes=${mes}&a침o=${a침o}`)
        .then(r => r.json())
        .then(data => {
            document.getElementById("ventasMes").textContent = `$${Number(data.ventas).toLocaleString()}`;
            document.getElementById("gastosMes").textContent = `$${Number(data.gastos).toLocaleString()}`;
            document.getElementById("gananciaMes").textContent = `$${Number(data.ganancia).toLocaleString()}`;
        });
}

// ================= FUNCIONES AUXILIARES =================
function llenarSelect(id, valores, esMes=false) {
    const select = document.getElementById(id);
    select.innerHTML = "";
    valores.forEach(v => {
        const opt = document.createElement("option");
        opt.value = v;
        opt.text = esMes ? nombresMeses[v] : v;
        select.appendChild(opt);
    });
}

async function fetchJSON(url) {
    const res = await fetch(url);
    return res.json();
}

// ================= EVENTOS =================
document.getElementById("a침o_general").onchange = async () => {
    await cargarMeses();
    cargarTodasLasGraficas();
};

document.getElementById("mes_general").onchange = cargarTodasLasGraficas;
</script>

{% endblock %}
