{% extends "base.html" %}

{% block content %}
<div class="dashboard-header">
    <h1>ðŸ“Š EstadÃ­sticas</h1>
</div>

<div class="summary-cards">

    <div class="summary-card kpi-card clientes">
        <div class="kpi-icon">ðŸ‘¥</div>
        <h3>Total de clientes</h3>
        <div class="card-number">{{ total_clientes }}</div>
        <span class="kpi-sub">Registrados</span>
    </div>

    <div class="summary-card kpi-card services">
        <div class="kpi-icon">ðŸ§¼</div>
        <h3>Total de servicios</h3>
        <div class="card-number">{{ total_servicios }}</div>
        <span class="kpi-sub">Registrados</span>
    </div>

</div>

<div class="date-selector" style="margin: 20px 0;">
    <form onsubmit="return false;" style="display:flex; gap:15px; align-items:center;">
        <label>Desde:</label>
        <input type="date" id="fecha_inicio" value="{{ hoy }}">

        <label>Hasta:</label>
        <input type="date" id="fecha_fin" value="{{ hoy }}">

        <label>Negocio:</label>
        <select id="negocio_select">
            <option value="all">Todos</option>
            {% for n in negocios %}
                <option value="{{ n.id_negocio }}">{{ n.nombre }}</option>
            {% endfor %}
        </select>

        <button onclick="cargarDashboard()">Aplicar</button>
    </form>
</div>



<div class="monthly-cards">
    <div class="monthly-card ventas">
        <h4>ðŸ’° Ingresos</h4>
        <p id="ventasMes">$0</p>
    </div>

    <div class="monthly-card gastos">
        <h4>ðŸ’¸ Gastos</h4>
        <p id="gastosMes">$0</p>
    </div>

    <div class="monthly-card ganancia">
        <h4>ðŸ“ˆ Ganancia</h4>
        <p id="gananciaMes">$0</p>
    </div>
</div>

<div class="stats-page">
    <div class="card stats-card">
        <h2 class="stats-title">Ingresos</h2>
        <canvas id="ingresosChart"></canvas>
    </div>

    <div class="card stats-card">
        <h2 class="stats-title">Gastos</h2>
        <canvas id="gastosChart"></canvas>
    </div>
</div>

<div class="stats-page">
    <div class="card stats-card">
        <h2 class="stats-title">Numero de Ventas</h2>
        <canvas id="ventasSemanaChart"></canvas>
    </div>

    <div class="card stats-card">
        <h2 class="stats-title">Unidades recibidas</h2>
        <canvas id="unidadesSemanaChart"></canvas>
    </div>
</div>

<div class="stats-page">
    <div class="card stats-card">
        <h2 class="stats-title">Tipo de pago</h2>
        <canvas id="tipoPagoChart"></canvas>
    </div>

    <div class="card stats-card">
        <h2 class="stats-title">Uso de servicios</h2>
        <canvas id="serviciosChart"></canvas>
    </div>
</div>



<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
let gastosChart;
let ingresosChart;
let ventasSemanaChart;
let unidadesSemanaChart;
let tipoPagoChart;
let serviciosChart;


const redPalette = [
    "#7f1d1d", 
    "#991b1b",
    "#b91c1c",
    "#dc2626",
    "#ef4444"
];



const serviciosPalette = [
    "#60a5fa",
    "#34d399", 
    "#fbbf24", 
    "#a78bfa",
    "#fb7185", 
    "#38bdf8", 
    "#4ade80" 
];




function aplicarColoresRojos(datasets) {
    return datasets.map((ds, i) => ({
        ...ds,
        backgroundColor: redPalette[i % redPalette.length],
        borderColor: "#7f1d1d",
        borderWidth: 1,
        borderRadius: 6
    }));
}



document.addEventListener("DOMContentLoaded", () => {
    initCharts();
    document.getElementById("fecha_inicio").addEventListener("change", cargarDashboard);
    document.getElementById("fecha_fin").addEventListener("change", cargarDashboard);
    document.getElementById("negocio_select").addEventListener("change", cargarDashboard);
    cargarDashboard();
});

function initCharts() {
    gastosChart = new Chart(document.getElementById("gastosChart"), {
        type: "bar",
        data: {
            labels: [],
            datasets: []
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    display: true,
                    labels: {
                        generateLabels(chart) {
                            return [{
                                text: "Gastos ($)",       
                                fillStyle: "#b91c1c",     
                                strokeStyle: "#7f1d1d",
                                lineWidth: 1,
                                hidden: false
                            }];
                        }
                    }
                },
                tooltip: {
                    callbacks: {
                        label(context) {
                            const proveedor = context.dataset.label;
                            const valor = context.raw || 0;
                            return `${proveedor}: $${valor.toLocaleString()}`;
                        }
                    }
                }
            },
            scales: {
                x: { stacked: true },
                y: { stacked: true, beginAtZero: true }
            }
        }
    });



    ingresosChart = new Chart(document.getElementById("ingresosChart"), {
        type: "bar",
        data: {
            labels: [],
            datasets: [{
                label: "Ingresos ($)",
                data: [],
                backgroundColor: "#22c55e",
                borderColor: "#16a34a" ,
                borderWidth: 1,
                borderRadius: 8
            }]
        },
        options: { scales: { y: { beginAtZero: true } } }
    });

    ventasSemanaChart = new Chart(document.getElementById("ventasSemanaChart"), {
        type: "bar",
        data: {
            labels: [],
            datasets: [{
                label: "NÃºmero de Ventas",
                data: [],
                backgroundColor: "#f59e0b", 
                borderColor: "#b45309",
                borderWidth: 1,
                borderRadius: 8
            }]
        },
        options: { scales: { y: { beginAtZero: true } } }
    });



    unidadesSemanaChart = new Chart(document.getElementById("unidadesSemanaChart"), {
        type: "bar",
        data: {
            labels: [],
            datasets: [{
                label: "Unidades",
                data: [],
                backgroundColor: "#14b8a6", 
                borderColor: "#0f766e",
                borderWidth: 1,
                borderRadius: 8
            }]
        },
        options: { scales: { y: { beginAtZero: true } } }
    });


    tipoPagoChart = new Chart(document.getElementById("tipoPagoChart"), {
        type: "pie",
        data: {
            labels: [],
            datasets: [{
                data: [],
                backgroundColor: [
                    "#34d399", 
                    "#fbbf24",
                ],
                borderColor: "#ffffff",
                borderWidth: 2
            }]
        },
        options: {
            plugins: {
                legend: {
                    labels: {
                        color: "#0b3c5d",
                        font: {
                            weight: "600"
                        }
                    }
                },
                tooltip: {
                    callbacks: {
                        label(ctx) {
                            const total = ctx.dataset.data.reduce((a, b) => a + b, 0);
                            const val = ctx.raw;
                            const pct = ((val / total) * 100).toFixed(1);
                            return `${ctx.label}: ${pct}% (${val})`;
                        }
                    }
                }
            }
        }
    });


    serviciosChart = new Chart(document.getElementById("serviciosChart"), {
        type: "pie",
        data: {
            labels: [],
            datasets: [{
                data: [],
                backgroundColor: serviciosPalette,
                borderColor: "#ffffff",
                borderWidth: 2
            }]
        },
        options: {
            plugins: {
                legend: {
                    labels: {
                        color: "#0b3c5d",
                        font: {
                            weight: "600"
                        }
                    }
                }
            }
        }
    });


}

async function cargarDashboard() {
    const inicio = document.getElementById("fecha_inicio").value;
    const fin = document.getElementById("fecha_fin").value;
    const negocio = document.getElementById("negocio_select").value;

    if (!inicio || !fin) {
        console.warn("Fechas incompletas");
        return;
    }

    const url = `/api/estadisticas/dashboard?inicio=${inicio}&fin=${fin}&id_negocio=${negocio}`;

    const res = await fetch(url);
    const data = await res.json();

    document.getElementById("ventasMes").textContent =
        `$${Number(data.kpis.ventas).toLocaleString()}`;

    document.getElementById("gastosMes").textContent =
        `$${Number(data.kpis.gastos).toLocaleString()}`;

    document.getElementById("gananciaMes").textContent =
        `$${Number(data.kpis.ganancia).toLocaleString()}`;

    const labels = data.ventas_semanales.map(x => x.label);
    const valores = data.ventas_semanales.map(x => x.total);

    ventasSemanaChart.data.labels = labels;
    ventasSemanaChart.data.datasets[0].data = valores;
    ventasSemanaChart.update();

    gastosChart.data.labels = data.gastos_semanales.labels;
    gastosChart.data.datasets = aplicarColoresRojos(data.gastos_semanales.datasets);
    gastosChart.update();

    const labelsUnidades = data.unidades_semanales.map(x => x.label);
    const valoresUnidades = data.unidades_semanales.map(x => x.total);

    unidadesSemanaChart.data.labels = labelsUnidades;
    unidadesSemanaChart.data.datasets[0].data = valoresUnidades;
    unidadesSemanaChart.update();

    const labelsIngresos = data.ingresos_semanales.map(x => x.label);
    const valoresIngresos = data.ingresos_semanales.map(x => x.total);

    ingresosChart.data.labels = labelsIngresos;
    ingresosChart.data.datasets[0].data = valoresIngresos;
    ingresosChart.update();


    tipoPagoChart.data.labels = data.ventas_tipo_pago.map(x => x.tipo_pago);
    tipoPagoChart.data.datasets[0].data = data.ventas_tipo_pago.map(x => x.total);
    tipoPagoChart.update();

    serviciosChart.data.labels = data.uso_servicios.map(x => x.nombre);
    serviciosChart.data.datasets[0].data = data.uso_servicios.map(x => x.total);
    serviciosChart.update();




    console.log("Dashboard data:", data);
}

</script>




{% endblock %}
