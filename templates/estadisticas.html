{% extends "base.html" %}

{% block content %}
<div class="dashboard-header">
    <h1>ğŸ“Š EstadÃ­sticas</h1>
</div>

<div class="summary-cards">

    <div class="summary-card kpi-card clientes">
        <div class="kpi-icon">ğŸ‘¥</div>
        <h3>Total de clientes</h3>
        <div class="card-number">{{ total_clientes }}</div>
        <span class="kpi-sub">Registrados</span>
    </div>

    <div class="summary-card kpi-card services">
        <div class="kpi-icon">ğŸ¬</div>
        <h3>Total de servicios</h3>
        <div class="card-number">{{ total_servicios }}</div>
        <span class="kpi-sub">Registrados</span>
    </div>

</div>

<div class="date-selector" style="margin: 20px 0;">
    <form onsubmit="return false;" style="display:flex; gap:15px; align-items:center;">
        <label>Desde:</label>
        <input type="date" id="fecha_inicio" value="{{ hoy }}">

        <label>Hasta:</label>
        <input type="date" id="fecha_fin" value="{{ hoy }}">

        <label>Negocio:</label>
        <select id="negocio_select">
            <option value="all">Todos</option>
            {% for n in negocios %}
                <option value="{{ n.id_negocio }}">{{ n.nombre }}</option>
            {% endfor %}
        </select>

        <button onclick="cargarDashboard()">Aplicar</button>
    </form>
</div>



<div class="monthly-cards">
    <div class="monthly-card ventas">
        <h4>ğŸ’° Ingresos</h4>
        <p id="ventasMes">$0</p>
    </div>

    <div class="monthly-card gastos">
        <h4>ğŸ’¸ Gastos</h4>
        <p id="gastosMes">$0</p>
    </div>

    <div class="monthly-card ganancia">
        <h4>ğŸ“ˆ Ganancia</h4>
        <p id="gananciaMes">$0</p>
    </div>
</div>

<div class="stats-page">
    <div class="card stats-card">
        <h2 class="stats-title">Ingresos</h2>
        <canvas id="ingresosChart"></canvas>
    </div>

    <div class="card stats-card">
        <h2 class="stats-title">Gastos</h2>
        <canvas id="gastosChart"></canvas>
    </div>
</div>

<div class="stats-page">
    <div class="card stats-card">
        <h2 class="stats-title">Numero de Ventas</h2>
        <canvas id="ventasSemanaChart"></canvas>
    </div>

    <div class="card stats-card">
        <h2 class="stats-title">Unidades recibidas</h2>
        <canvas id="unidadesSemanaChart"></canvas>
    </div>
</div>

<div class="stats-page">
    <div class="card stats-card full-width">
        <h2 class="stats-title">Ventas por dÃ­a</h2>
        <canvas id="ventasPorDiaChart"></canvas>
    </div>
</div>

<div class="stats-page">
    <div class="card stats-card">
        <h2 class="stats-title">Tipo de pago</h2>
        <canvas id="tipoPagoChart"></canvas>
    </div>

    <div class="card stats-card">
        <h2 class="stats-title">Uso de servicios</h2>
        <canvas id="serviciosChart"></canvas>
    </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
let gastosChart;
let ingresosChart;
let ventasSemanaChart;
let unidadesSemanaChart;
let tipoPagoChart;
let serviciosChart;
let ventasPorDiaChart;



const redPalette = [
    "#7f1d1d", 
    "#991b1b",
    "#b91c1c",
    "#dc2626",
    "#ef4444"
];



const serviciosPalette = [
    "#60a5fa",
    "#34d399", 
    "#fbbf24", 
    "#a78bfa",
    "#fb7185", 
    "#38bdf8", 
    "#4ade80" 
];




function aplicarColoresRojos(datasets) {
    return datasets.map((ds, i) => ({
        ...ds,
        backgroundColor: redPalette[i % redPalette.length],
        borderColor: "#7f1d1d",
        borderWidth: 1,
        borderRadius: 6
    }));
}



document.addEventListener("DOMContentLoaded", () => {
    initCharts();
});

function initCharts() {
    gastosChart = new Chart(document.getElementById("gastosChart"), {
        type: "bar",
        data: {
            labels: [],
            datasets: []
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    display: true,
                    labels: {
                        generateLabels(chart) {
                            return [{
                                text: "Gastos ($)",       
                                fillStyle: "#b91c1c",     
                                strokeStyle: "#7f1d1d",
                                lineWidth: 1,
                                hidden: false
                            }];
                        }
                    }
                },
                tooltip: {
                    callbacks: {
                        label(context) {
                            const proveedor = context.dataset.label;
                            const valor = context.raw || 0;
                            return `${proveedor}: $${valor.toLocaleString()}`;
                        }
                    }
                }
            },
            scales: {
                x: { stacked: true },
                y: { stacked: true, beginAtZero: true }
            }
        }
    });



    ingresosChart = new Chart(document.getElementById("ingresosChart"), {
        type: "bar",
        data: {
            labels: [],
            datasets: [{
                label: "Ingresos ($)",
                data: [],
                backgroundColor: "#22c55e",
                borderColor: "#16a34a" ,
                borderWidth: 1,
                borderRadius: 8
            }]
        },
        options: { scales: { y: { beginAtZero: true } } }
    });

    ventasSemanaChart = new Chart(document.getElementById("ventasSemanaChart"), {
        type: "bar",
        data: {
            labels: [],
            datasets: [{
                label: "NÃºmero de Ventas",
                data: [],
                backgroundColor: "#f59e0b", 
                borderColor: "#b45309",
                borderWidth: 1,
                borderRadius: 8
            }]
        },
        options: { scales: { y: { beginAtZero: true } } }
    });



    unidadesSemanaChart = new Chart(document.getElementById("unidadesSemanaChart"), {
        type: "bar",
        data: {
            labels: [],
            datasets: [{
                label: "Unidades",
                data: [],
                backgroundColor: "#14b8a6", 
                borderColor: "#0f766e",
                borderWidth: 1,
                borderRadius: 8
            }]
        },
        options: { scales: { y: { beginAtZero: true } } }
    });


    tipoPagoChart = new Chart(document.getElementById("tipoPagoChart"), {
        type: "pie",
        data: {
            labels: [],
            datasets: [{
                data: [],
                backgroundColor: [
                    "#34d399", 
                    "#fbbf24",
                ],
                borderColor: "#ffffff",
                borderWidth: 2
            }]
        },
        options: {
            plugins: {
                legend: {
                    labels: {
                        color: "#0b3c5d",
                    }
                },
                tooltip: {
                    callbacks: {
                        label(ctx) {
                            const total = ctx.dataset.data.reduce((a, b) => a + b, 0);
                            const val = ctx.raw;
                            const pct = ((val / total) * 100).toFixed(1);
                            return `${ctx.label}: ${pct}% (${val})`;
                        }
                    }
                }
            }
        }
    });


    serviciosChart = new Chart(document.getElementById("serviciosChart"), {
        type: "pie",
        data: {
            labels: [],
            datasets: [{
                data: [],
                backgroundColor: serviciosPalette,
                borderColor: "#ffffff",
                borderWidth: 2
            }]
        },
        options: {
            plugins: {
                legend: {
                    labels: {
                        color: "#0b3c5d",
                    }
                }
            }
        }
    });


    ventasPorDiaChart = new Chart(
    document.getElementById("ventasPorDiaChart"),
    {
        type: "bar",
        data: {
            labels: ["Lunes", "Martes", "MiÃ©rcoles", "Jueves", "Viernes", "SÃ¡bado"],
            datasets: [{
                label: "Ventas",
                data: [0, 0, 0, 0, 0, 0],
                backgroundColor: "#6366f1",
                borderColor: "#4338ca",
                borderWidth: 1,
                borderRadius: 8
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: { precision: 0 }
                }
            }
        }
    }
);


}

async function cargarDashboard() {
    try {
        const inicio = document.getElementById("fecha_inicio").value;
        const fin = document.getElementById("fecha_fin").value;
        const negocio = document.getElementById("negocio_select").value;

        if (!inicio || !fin) {
            console.warn("âš ï¸ Fechas incompletas");
            return;
        }

        const url = `/api/estadisticas/dashboard?inicio=${inicio}&fin=${fin}&id_negocio=${negocio}`;
        console.log("ğŸ“¡ URL:", url);

        const res = await fetch(url);

        // ğŸ‘‡ CLAVE: valida respuesta HTTP
        if (!res.ok) {
            const text = await res.text();
            console.error("âŒ Error HTTP:", res.status, text);
            return;
        }

        const data = await res.json();
        console.log("âœ… Dashboard data:", data);

        // ---- KPIs ----
        document.getElementById("ventasMes").textContent =
            `$${Number(data.kpis?.ventas || 0).toLocaleString()}`;

        document.getElementById("gastosMes").textContent =
            `$${Number(data.kpis?.gastos || 0).toLocaleString()}`;

        document.getElementById("gananciaMes").textContent =
            `$${Number(data.kpis?.ganancia || 0).toLocaleString()}`;

        // ---- Ventas semana ----
        if (data.ventas_semanales) {
            ventasSemanaChart.data.labels = data.ventas_semanales.map(x => x.label);
            ventasSemanaChart.data.datasets[0].data =
                data.ventas_semanales.map(x => x.total);
            ventasSemanaChart.update();
        }

        // ---- Gastos ----
        if (data.gastos_semanales) {
            gastosChart.data.labels = data.gastos_semanales.labels || [];
            gastosChart.data.datasets =
                aplicarColoresRojos(data.gastos_semanales.datasets || []);
            gastosChart.update();
        }

        // ---- Unidades ----
        if (data.unidades_semanales) {
            unidadesSemanaChart.data.labels =
                data.unidades_semanales.map(x => x.label);
            unidadesSemanaChart.data.datasets[0].data =
                data.unidades_semanales.map(x => x.total);
            unidadesSemanaChart.update();
        }

        // ---- Ingresos ----
        if (data.ingresos_semanales) {
            ingresosChart.data.labels =
                data.ingresos_semanales.map(x => x.label);
            ingresosChart.data.datasets[0].data =
                data.ingresos_semanales.map(x => x.total);
            ingresosChart.update();
        }

        // ---- Tipo pago ----
        if (data.ventas_tipo_pago) {
            tipoPagoChart.data.labels =
                data.ventas_tipo_pago.map(x => x.tipo_pago);
            tipoPagoChart.data.datasets[0].data =
                data.ventas_tipo_pago.map(x => x.total);
            tipoPagoChart.update();
        }

        // ---- Servicios ----
        if (data.uso_servicios) {
            serviciosChart.data.labels =
                data.uso_servicios.map(x => x.nombre);
            serviciosChart.data.datasets[0].data =
                data.uso_servicios.map(x => x.total);
            serviciosChart.update();
        }

        // ---- Ventas por dÃ­a ----
        if (data.ventas_por_dia) {
            ventasPorDiaChart.data.datasets[0].data =
                data.ventas_por_dia;
            ventasPorDiaChart.update();
        }

    } catch (error) {
        console.error("ğŸ”¥ Error en cargarDashboard:", error);
    }
}

</script>




{% endblock %}
