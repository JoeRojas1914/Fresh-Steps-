{% extends "base.html" %}

{% block content %}
{% from "macros/badges.html" import badge_negocio %}


<h1>ðŸ’¸ Gastos</h1>

<form method="GET"
      action="{{ url_for('gastos.gastos') }}"
      class="filtro-box">

  <div class="filtro-row">

    <div class="filtro-item">
      <label>Negocio</label>
      <select name="id_negocio">
        <option value="">Todos</option>
        {% for n in negocios %}
          <option value="{{ n.id_negocio }}"
            {% if request.args.get('id_negocio') == n.id_negocio|string %}
              selected
            {% endif %}
          >
            {{ n.nombre }}
          </option>
        {% endfor %}
      </select>
    </div>

    <div class="filtro-item">
      <label>Desde</label>
      <input
        type="date"
        name="fecha_inicio"
        value="{{ request.args.get('fecha_inicio', '') }}"
      >
    </div>

    <div class="filtro-item">
      <label>Hasta</label>
      <input
        type="date"
        name="fecha_fin"
        value="{{ request.args.get('fecha_fin', '') }}"
      >
    </div>

    <div class="filtro-actions">
      <button type="submit">Aplicar</button>

      {% if request.args.get('id_negocio') or request.args.get('fecha_inicio') or request.args.get('fecha_fin') %}
        <a href="{{ url_for('gastos.gastos') }}">
          Limpiar
        </a>
      {% endif %}
    </div>

  </div>
</form>

<form method="GET" action="{{ url_for('gastos.gastos') }}" class="filtro-toggle">

    <input type="hidden" name="id_negocio" value="{{ request.args.get('id_negocio','') }}">
    <input type="hidden" name="fecha_inicio" value="{{ request.args.get('fecha_inicio','') }}">
    <input type="hidden" name="fecha_fin" value="{{ request.args.get('fecha_fin','') }}">

    <label class="switch">
        <input type="checkbox"
               name="eliminados"
               value="1"
               onchange="this.form.submit()"
               {% if incluir_eliminados %}checked{% endif %}>
        <span class="slider"></span>
    </label>

    <span class="toggle-text">Mostrar eliminados</span>
</form>



{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    {% for category, message in messages %}
      <div class="alert {{ category }}">
        {{ message }}
      </div>
    {% endfor %}
  {% endif %}
{% endwith %}

<button onclick="abrirModal()">âž• Agregar gasto</button>


<div id="modal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="cerrarModal()">&times;</span>

        <h2 id="modalTitulo">Agregar gasto</h2>

        <form method="POST" action="/gastos/guardar" class="modal-form">
            <input type="hidden" name="id_gasto" id="id_gasto">

            <div class="modal-field">
                <label for="id_negocio">Negocio</label>
                <select name="id_negocio" id="id_negocio" required>
                    <option value="">Seleccione un negocio</option>
                    {% for n in negocios %}
                        <option value="{{ n.id_negocio }}">{{ n.nombre }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="modal-field">
                <label for="gasto_descripcion">DescripciÃ³n</label>
                <input id="gasto_descripcion" type="text" name="descripcion" required>
            </div>

            <div class="modal-field">
                <label for="gasto_proveedor">Proveedor</label>
                <input id="gasto_proveedor" type="text" name="proveedor" required>
            </div>

            <div class="modal-field">
                <label for="gasto_total">Total</label>
                <input id="gasto_total" type="number" name="total" step="0.01" min="0" inputmode="decimal" required>
            </div>

            <div class="modal-field">
                <label for="gasto_fecha">Fecha de registro</label>
                <input id="gasto_fecha" type="date" name="fecha_registro">
            </div>

            <div class="modal-field">
                <label>Comprobante</label>
                <select name="tipo_comprobante" id="tipo_comprobante" required>
                    <option value="ticket">Ticket</option>
                    <option value="factura">Factura</option>
                </select>
            </div>

            <div class="modal-field">
                <label>MÃ©todo de pago</label>
                <select name="tipo_pago" id="tipo_pago" required>
                    <option value="efectivo">Efectivo</option>
                    <option value="TDC">Tarjeta de crÃ©dito</option>
                    <option value="transferencia">Transferencia</option>
                </select>
            </div>

            <button type="submit" class="btn-guardar-modal">
                Guardar gasto
            </button>
        </form>

    </div>
</div>

<hr>


<table>
    <thead>
        <tr>
            <th>Negocio</th>
            <th>DescripciÃ³n</th>
            <th>Proveedor</th>
            <th>Total</th>
            <th>Comprobante</th>
            <th>Pago</th>
            <th>Fecha de registro</th>
            <th>Estado</th>
            <th>Acciones</th>
        </tr>
    </thead>
    <tbody>
        {% for g in gastos %}
        <tr>
            <td>{{ badge_negocio(g.negocio) }}</td>
            <td>{{ g.descripcion }}</td>
            <td>{{ g.proveedor }}</td>
            <td>${{ "%.2f"|format(g.total) }}</td>
            <td>
                {% if g.tipo_comprobante == "factura" %}
                    Factura
                {% else %}
                    Ticket
                {% endif %}
            </td>
            <td>
                {% if g.tipo_pago == "efectivo" %}
                    Efectivo
                {% elif g.tipo_pago == "transferencia" %}
                    Transferencia
                {% else %}
                    Tarjeta de CrÃ©dito
                {% endif %}
            </td>

            <td>{{ g.fecha_registro.strftime("%d %b %Y") }}</td>

            <td>
                {% if g.activo %}
                    <span class="status status-completado">Activo</span>
                {% else %}
                    <span class="status status-pendiente">Eliminado</span>
                {% endif %}
            </td>

            <td>

                {% if g.activo %}

                <button class="btn-edit"
                    onclick='editarGasto({{ g.id_gasto }}, {{ g.id_negocio }}, {{ g.descripcion|tojson }}, {{ g.proveedor|tojson }}, {{ g.total|tojson }}, "{{ g.fecha_registro.strftime("%Y-%m-%d") if g.fecha_registro else "" }}", "{{ g.tipo_comprobante }}", "{{ g.tipo_pago }}")'>
                    Editar
                </button>

                <button class="btn-info" onclick="verHistorial({{ g.id_gasto }})">
                    Historial
                </button>

                <a href="/gastos/eliminar/{{ g.id_gasto }}" class="btn-delete" onclick="return confirm('Â¿Seguro que desea eliminar el gasto?')">
                    Eliminar
                </a>

            {% else %}
                <a href="/gastos/restaurar/{{ g.id_gasto }}"
                class="btn-edit"
                style="background:linear-gradient(to right,#3b82f6,#2563eb);">
                Restaurar
                </a>
            {% endif %}
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<div id="modalHistorial" class="modal">
  <div class="modal-content" style="width:700px; max-width:95vw;">
    <span class="close" onclick="cerrarHistorial()">&times;</span>

    <h2>Historial de cambios</h2>

    <table id="tablaHistorial">
      <thead>
        <tr>
          <th>AcciÃ³n</th>
          <th>Usuario</th>
          <th>Fecha</th>
          <th>Cambios</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>


<div class="paginacion">
    {% if total_paginas > 1 %}
        {# Calcular bloque de 10 pÃ¡ginas #}
        {% set bloque = ((pagina - 1) // 10) %}
        {% set inicio = bloque * 10 + 1 %}
        {% set fin = inicio + 9 %}
        {% if fin > total_paginas %}
            {% set fin = total_paginas %}
        {% endif %}

        {# BotÃ³n Â«AnteriorÂ» para desplazar el bloque hacia atrÃ¡s #}
        {% if inicio > 1 %}
            <a href="{{ url_for('gastos.gastos', pagina=p, id_negocio=request.args.get('id_negocio'), fecha_inicio=request.args.get('fecha_inicio'), fecha_fin=request.args.get('fecha_fin')) }}">Â«</a>
        {% endif %}

        {# Mostrar pÃ¡ginas del bloque #}
        {% for p in range(inicio, fin + 1) %}
            {% if p == pagina %}
                <strong>{{ p }}</strong>
            {% else %}
                <a href="{{ url_for('gastos.gastos', pagina=p, id_negocio=request.args.get('id_negocio'), fecha_inicio=request.args.get('fecha_inicio'), fecha_fin=request.args.get('fecha_fin')) }}">Â«</a>
            {% endif %}
        {% endfor %}

        {# BotÃ³n Â«SiguienteÂ» para desplazar el bloque hacia adelante #}
        {% if fin < total_paginas %}
            <a href="{{ url_for('gastos.gastos', pagina=inicio+10, id_negocio=request.args.get('id_negocio'), fecha_inicio=request.args.get('fecha_inicio'), fecha_fin=request.args.get('fecha_fin')) }}">Â»</a>
        {% endif %}
    {% endif %}
</div>




<script>
    function abrirModal() {
        document.getElementById("modal").style.display = "block";
        document.getElementById("modalTitulo").innerText = "Agregar Gasto";
        document.getElementById("id_gasto").value = "";
    }

    function cerrarModal() {
        document.getElementById("modal").style.display = "none";
    }

    function editarGasto(id, id_negocio, descripcion, proveedor, total, fecha_registro, tipo_comprobante, tipo_pago)
 {
        abrirModal();
        document.getElementById("modalTitulo").innerText = "Editar gasto";

        document.getElementById("id_gasto").value = id;
        document.getElementById("id_negocio").value = id_negocio;
        document.querySelector("[name=descripcion]").value = descripcion;
        document.querySelector("[name=proveedor]").value = proveedor;
        document.querySelector("[name=total]").value = total;
        document.querySelector("[name=fecha_registro]").value = fecha_registro;
        document.getElementById("tipo_comprobante").value = tipo_comprobante;
        document.getElementById("tipo_pago").value = tipo_pago;

    }

    function cerrarHistorial() {
        document.getElementById("modalHistorial").style.display = "none";
    }

    async function verHistorial(id) {

        const modal = document.getElementById("modalHistorial");
        const tbody = document.querySelector("#tablaHistorial tbody");

        tbody.innerHTML = "<tr><td colspan='4'>Cargando...</td></tr>";
        modal.style.display = "block";

        const res = await fetch(`/gastos/${id}/historial`);
        const data = await res.json();

        if (!data.length) {
            tbody.innerHTML = "<tr><td colspan='4'>Sin historial</td></tr>";
            return;
        }

        tbody.innerHTML = "";

        data.forEach(h => {

            const antes = h.datos_antes ? JSON.parse(h.datos_antes) : null;
            const despues = h.datos_despues ? JSON.parse(h.datos_despues) : null;

            let cambios = "";

            if (h.accion === "RESTAURADO") {
                cambios = `
                    <span">
                        Registro restaurado
                    </span>
                `;
            }
            else if (antes && despues) {
                Object.keys(despues).forEach(k => {
                    if (antes[k] !== despues[k]) {
                        cambios += `
                            <div>
                                <b>${k}</b>: 
                                <span style="color:#ef4444">${antes[k]}</span> â†’ 
                                <span style="color:#22c55e">${despues[k]}</span>
                            </div>
                        `;
                    }
                });
            }
            else if (despues) {
                cambios = "Registro creado";
            }
            else {
                cambios = "Registro eliminado";
            }

            tbody.innerHTML += `
                <tr>
                    <td><b>${h.accion}</b></td>
                    <td>${h.usuario}</td>
                    <td>${new Date(h.fecha).toLocaleString()}</td>
                    <td>${cambios}</td>
                </tr>
            `;
        });
    }

    </script>
    
{% endblock %}