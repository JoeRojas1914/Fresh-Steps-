{% extends "base.html" %}

{% block content %}
{% from "macros/badges.html" import badge_negocio %}
{% from "components/alerts.html" import alerts %}
{% from "components/pagination.html" import pagination %}
{% from "components/table.html" import table %}


<h1>üí∏ Gastos</h1>

{{ alerts(get_flashed_messages(with_categories=true)) }}

<form method="GET"
      action="{{ url_for('gastos.gastos') }}"
      class="filtro-box">

  <div class="filtro-row">

    <div class="filtro-item">
      <label>Negocio</label>
      <select name="id_negocio">
        <option value="">Todos</option>
        {% for n in negocios %}
          <option value="{{ n.id_negocio }}"
            {% if request.args.get('id_negocio') == n.id_negocio|string %}
              selected
            {% endif %}
          >
            {{ n.nombre }}
          </option>
        {% endfor %}
      </select>
    </div>

    <div class="filtro-item">
      <label>Desde</label>
      <input
        type="date"
        name="fecha_inicio"
        value="{{ request.args.get('fecha_inicio', '') }}"
      >
    </div>

    <div class="filtro-item">
      <label>Hasta</label>
      <input
        type="date"
        name="fecha_fin"
        value="{{ request.args.get('fecha_fin', '') }}"
      >
    </div>

    <div class="filtro-actions">
      <button type="submit" class="btn btn--primary btn--sm">Aplicar</button>

      {% if request.args.get('id_negocio') or request.args.get('fecha_inicio') or request.args.get('fecha_fin') %}
        <a href="{{ url_for('gastos.gastos') }}">
          Limpiar
        </a>
      {% endif %}
    </div>

  </div>
</form>

<form method="GET" action="{{ url_for('gastos.gastos') }}" class="filtro-toggle">

    <input type="hidden" name="id_negocio" value="{{ request.args.get('id_negocio','') }}">
    <input type="hidden" name="fecha_inicio" value="{{ request.args.get('fecha_inicio','') }}">
    <input type="hidden" name="fecha_fin" value="{{ request.args.get('fecha_fin','') }}">

    <label class="switch">
        <input type="checkbox"
               name="eliminados"
               value="1"
               onchange="this.form.submit()"
               {% if incluir_eliminados %}checked{% endif %}>
        <span class="slider"></span>
    </label>

    <span class="toggle-text">Mostrar eliminados</span>
</form>


<button onclick="abrirModal()" class="btn btn--primary">‚ûï Agregar gasto</button>


<div id="modal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="cerrarModal()">&times;</span>

        <h2 id="modalTitulo">Agregar gasto</h2>

        <form method="POST" action="/gastos/guardar" class="modal-form">
            <input type="hidden" name="id_gasto" id="id_gasto">

            <div class="modal-field">
                <label for="id_negocio">Negocio</label>
                <select name="id_negocio" id="id_negocio" required>
                    <option value="">Seleccione un negocio</option>
                    {% for n in negocios %}
                        <option value="{{ n.id_negocio }}">{{ n.nombre }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="modal-field">
                <label for="gasto_descripcion">Descripci√≥n</label>
                <input id="gasto_descripcion" type="text" name="descripcion" required>
            </div>

            <div class="modal-field">
                <label for="gasto_proveedor">Proveedor</label>
                <input id="gasto_proveedor" type="text" name="proveedor" required>
            </div>

            <div class="modal-field">
                <label for="gasto_total">Total</label>
                <input id="gasto_total" type="number" name="total" step="0.01" min="0" inputmode="decimal" required>
            </div>

            <div class="modal-field">
                <label for="gasto_fecha">Fecha de registro</label>
                <input id="gasto_fecha" type="date" name="fecha_registro">
            </div>

            <div class="modal-field">
                <label>Comprobante</label>
                <select name="tipo_comprobante" id="tipo_comprobante" required>
                    <option value="ticket">Ticket</option>
                    <option value="factura">Factura</option>
                </select>
            </div>

            <div class="modal-field">
                <label>M√©todo de pago</label>
                <select name="tipo_pago" id="tipo_pago" required>
                    <option value="efectivo">Efectivo</option>
                    <option value="TDC">Tarjeta de cr√©dito</option>
                    <option value="transferencia">Transferencia</option>
                </select>
            </div>

            <button type="submit"  class="btn btn--primary btn--lg">
                Guardar gasto
            </button>
        </form>

    </div>
</div>

<hr>


{% call table([
    "Negocio",
    "Descripci√≥n",
    "Proveedor",
    "Total",
    "Comprobante",
    "Pago",
    "Fecha de registro",
    "Estado",
    "Acciones"
]) %}

    {% for g in gastos %}
    <tr>
        <td>{{ badge_negocio(g.negocio) }}</td>
        <td>{{ g.descripcion }}</td>
        <td>{{ g.proveedor }}</td>
        <td>${{ "%.2f"|format(g.total) }}</td>

        <td>
            {% if g.tipo_comprobante == "factura" %}
                Factura
            {% else %}
                Ticket
            {% endif %}
        </td>

        <td>
            {% if g.tipo_pago == "efectivo" %}
                Efectivo
            {% elif g.tipo_pago == "transferencia" %}
                Transferencia
            {% else %}
                Tarjeta de Cr√©dito
            {% endif %}
        </td>

        <td>{{ g.fecha_registro.strftime("%d %b %Y") }}</td>

        <td>
            {% if g.activo %}
                <span class="status status-completado">Activo</span>
            {% else %}
                <span class="status status-pendiente">Eliminado</span>
            {% endif %}
        </td>

        <td>
        {% if g.activo %}

            <button type="button"
                class="btn btn--success btn--sm"
                onclick='editarGasto({{ g.id_gasto }}, {{ g.id_negocio }}, {{ g.descripcion|tojson }}, {{ g.proveedor|tojson }}, {{ g.total|tojson }}, "{{ g.fecha_registro.strftime("%Y-%m-%d") if g.fecha_registro else "" }}", "{{ g.tipo_comprobante }}", "{{ g.tipo_pago }}")'>
                Editar
            </button>

            <button type="button"
                    class="btn btn--info btn--sm" 
                    onclick="verHistorial({{ g.id_gasto }})">
                Historial
            </button>

            <a href="/gastos/eliminar/{{ g.id_gasto }}"
               class="btn btn--danger btn--sm"
               onclick="return confirm('¬øSeguro que desea eliminar el gasto?')">
               Eliminar
            </a>

        {% else %}

            <a href="/gastos/restaurar/{{ g.id_gasto }}"
               class="btn btn--primary btn--sm">
               Restaurar
            </a>

        {% endif %}
        </td>
    </tr>
    {% endfor %}

{% endcall %}


<div id="modalHistorial" class="modal">
  <div class="modal-content" style="width:700px; max-width:95vw;">
    <span class="close" onclick="cerrarHistorial()">&times;</span>

    <h2>Historial de cambios</h2>

    <table id="tablaHistorial" class="table table--striped table--hover">
      <thead>
        <tr>
          <th>Acci√≥n</th>
          <th>Usuario</th>
          <th>Fecha</th>
          <th>Cambios</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>


{% from "components/pagination.html" import pagination %}

{{ pagination(
    pagina,
    total_paginas,
    'gastos.gastos',
    {
      "id_negocio": request.args.get('id_negocio'),
      "fecha_inicio": request.args.get('fecha_inicio'),
      "fecha_fin": request.args.get('fecha_fin')
    }
) }}

    
{% endblock %}

{% block scripts %}
    <script src="{{ url_for('static', filename='js/gastos.js') }}"></script>
{% endblock %}
