{% extends "base.html" %}

{% block content %}
{% from "macros/badges.html" import badge_negocio %}
{% from "components/alerts.html" import alerts %}
{% from "components/pagination.html" import pagination %}
{% from "components/table.html" import table %}
{% from "components/modal.html" import modal %}


<h1>üè¨ Servicios</h1>

{{ alerts(get_flashed_messages(with_categories=true)) }}

<form method="GET" action="/servicios" class="search-bar">
    <select name="id_negocio" onchange="this.form.submit()">
        <option value="">Todos los negocios</option>
        {% for n in negocios %}
            <option value="{{ n.id_negocio }}"
                {% if id_negocio and id_negocio|int == n.id_negocio %}
                    selected
                {% endif %}
            >
                {{ n.nombre }}
            </option>
        {% endfor %}
    </select>
</form>

<form method="GET" action="/servicios" class="filtro-toggle">
    <input type="hidden" name="id_negocio" value="{{ id_negocio or '' }}">

    <label class="switch">
        <input type="checkbox"
               name="eliminados"
               value="1"
               onchange="this.form.submit()"
               {% if incluir_eliminados %}checked{% endif %}>
        <span class="slider"></span>
    </label>

    <span class="toggle-text">
        Mostrar eliminados
    </span>
</form>


<button onclick="abrirNuevoServicio()" class="btn btn--primary">‚ûï Agregar servicio</button>


{% call(section) modal("modalServicio", "Agregar servicio", "md") %}

{% if section == 'body' %}
<form id="formServicio" method="POST" action="/servicios/guardar" class="modal-form">

    <input type="hidden" name="id_servicio" id="id_servicio">

    <div class="modal-field">
        <label for="id_negocio">Negocio</label>
        <select name="id_negocio" id="id_negocio" required>
            <option value="">Seleccione un negocio</option>
            {% for n in negocios %}
                <option value="{{ n.id_negocio }}">{{ n.nombre }}</option>
            {% endfor %}
        </select>
    </div>

    <div class="modal-field">
        <label for="servicio_nombre">Nombre del servicio</label>
        <input id="servicio_nombre" type="text" name="nombre" required>
    </div>

    <div class="modal-field">
        <label for="servicio_precio">Precio</label>
        <input id="servicio_precio" type="number" step="0.01" name="precio" required>
    </div>
</form>
{% endif %}

{% if section == 'footer' %}
    <button class="btn btn--danger btn--sm"
            onclick="cerrarModal('modalServicio')">
        Cancelar
    </button>

    <button type="submit"
            form="formServicio"
            class="btn btn--primary btn--lg">
        Guardar servicio
    </button>
{% endif %}

{% endcall %}


<hr>

{% call table([
    "Negocio",
    "Servicio",
    "Precio",
    "Estado",
    "Acciones"
]) %}

    {% for s in servicios %}
    <tr>
        <td>{{ badge_negocio(s.negocio) }}</td>
        <td>{{ s.nombre }}</td>
        <td>${{ s.precio }}</td>
        <td>
            {% if s.activo %}
                <span class="status status-completado">Activo</span>
            {% else %}
                <span class="status status-pendiente">Eliminado</span>
            {% endif %}
        </td>

        <td>
        {% if s.activo %}

            <button class="btn btn--success btn--sm"
                data-id="{{ s.id_servicio }}"
                data-negocio="{{ s.id_negocio }}"
                data-nombre="{{ s.nombre }}"
                data-precio="{{ s.precio }}"
                onclick="editarServicio(this)">
                Editar
            </button>

            <button class="btn btn--info btn--sm"
                onclick="verHistorialServicio({{ s.id_servicio }})">
                Historial
            </button>

            <a href="/servicios/eliminar/{{ s.id_servicio }}"
               class="btn btn--danger btn--sm"
               onclick="return confirm('¬øEliminar servicio?')">
               Eliminar
            </a>

        {% else %}

            <a href="/servicios/restaurar/{{ s.id_servicio }}"
               class="btn btn--primary btn--sm">
               Restaurar
            </a>

        {% endif %}
        </td>
    </tr>
    {% endfor %}

{% endcall %}


{% call(section) modal("modalHistorialServicio", "Historial del servicio", "lg") %}

{% if section == 'body' %}
  {% call table([
      "Acci√≥n",
      "Usuario",
      "Fecha",
      "Cambios"
  ]) %}
    <tbody id="tablaHistorialServicio"></tbody>
  {% endcall %}
{% endif %}

{% endcall %}


{% from "components/pagination.html" import pagination %}

{{ pagination(
    pagina,
    total_paginas,
    'gastos.gastos',
    {
      "id_negocio": request.args.get('id_negocio'),
      "fecha_inicio": request.args.get('fecha_inicio'),
      "fecha_fin": request.args.get('fecha_fin')
    }
) }}


{% endblock %}

{% block scripts %}
    <script src="{{ url_for('static', filename='js/modal.js') }}"></script>
    <script src="{{ url_for('static', filename='js/servicios.js') }}"></script>
{% endblock %}