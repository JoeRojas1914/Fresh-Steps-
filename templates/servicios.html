{% extends "base.html" %}

{% block content %}
{% from "macros/badges.html" import badge_negocio %}

<h1>üè¨ Servicios</h1>

{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    {% for category, message in messages %}
      <div class="alert {{ category }}">
        {{ message }}
      </div>
    {% endfor %}
  {% endif %}
{% endwith %}

<form method="GET" action="/servicios" class="search-bar">
    <select name="id_negocio" onchange="this.form.submit()">
        <option value="">Todos los negocios</option>
        {% for n in negocios %}
            <option value="{{ n.id_negocio }}"
                {% if id_negocio and id_negocio|int == n.id_negocio %}
                    selected
                {% endif %}
            >
                {{ n.nombre }}
            </option>
        {% endfor %}
    </select>
</form>

<form method="GET" action="/servicios" class="filtro-toggle">
    <input type="hidden" name="id_negocio" value="{{ id_negocio or '' }}">

    <label class="switch">
        <input type="checkbox"
               name="eliminados"
               value="1"
               onchange="this.form.submit()"
               {% if incluir_eliminados %}checked{% endif %}>
        <span class="slider"></span>
    </label>

    <span class="toggle-text">
        Mostrar eliminados
    </span>
</form>





<button onclick="abrirModal()"  class="btn btn--primary">‚ûï Agregar servicio</button>


<div id="modal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="cerrarModal()">&times;</span>

        <h2 id="tituloModal">Agregar servicio</h2>

        <form method="POST" action="/servicios/guardar" class="modal-form">
            <input type="hidden" name="id_servicio" id="id_servicio">
            <div class="modal-field">
                <label for="id_negocio">Negocio</label>
                <select name="id_negocio" id="id_negocio" required>
                    <option value="">Seleccione un negocio</option>
                    {% for n in negocios %}
                        <option value="{{ n.id_negocio }}">{{ n.nombre }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="modal-field">
                <label for="servicio_nombre">Nombre del servicio</label>
                <input id="servicio_nombre" type="text" name="nombre" required>
            </div>

            <div class="modal-field">
                <label for="servicio_precio">Precio</label>
                <input id="servicio_precio" type="number" step="0.01" name="precio" required>
            </div>

            <button type="submit"  class="btn btn--primary btn--lg">
                Guardar servicio
            </button>
        </form>
    </div>
</div>

<hr>

<table class="table table--striped table--hover">
    <thead>
        <tr>
            <th>Negocio</th>
            <th>Servicio</th>
            <th>Precio</th>
            <th>Estado</th>
            <th>Acciones</th>
        </tr>
    </thead>
    <tbody>
        {% for s in servicios %}
        <tr>
            <td>{{ badge_negocio(s.negocio) }}</td>
            <td>{{ s.nombre }}</td>
            <td>${{ s.precio }}</td>
            <td>
                {% if s.activo %}
                    <span class="status status-completado">Activo</span>
                {% else %}
                    <span class="status status-pendiente">Eliminado</span>
                {% endif %}
            </td>

            <td>

            {% if s.activo %}

                <button class="btn btn--success btn--sm"
                    data-id="{{ s.id_servicio }}"
                    data-negocio="{{ s.id_negocio }}"
                    data-nombre="{{ s.nombre }}"
                    data-precio="{{ s.precio }}"
                    onclick="editarServicio(this)">
                    Editar
                </button>

                <button class="btn btn--info btn--sm"
                    onclick="verHistorialServicio({{ s.id_servicio }})">
                    Historial
                </button>

                <a href="/servicios/eliminar/{{ s.id_servicio }}"
                class="btn btn--danger btn--sm"
                onclick="return confirm('¬øEliminar servicio?')">
                Eliminar
                </a>

            {% else %}

                <a href="/servicios/restaurar/{{ s.id_servicio }}"
                class="btn btn--primary btn--sm">
                Restaurar
                </a>

            {% endif %}

            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<div id="modalHistorialServicio" class="modal">
  <div class="modal-content" style="width:750px; max-width:95vw;">
    <span class="close" onclick="cerrarHistorialServicio()">&times;</span>

    <h2>Historial del servicio</h2>

    <table id="tablaHistorialServicio" class="table table--striped table--hover">
      <thead>
        <tr>
          <th>Acci√≥n</th>
          <th>Usuario</th>
          <th>Fecha</th>
          <th>Cambios</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>


<div class="paginacion">
    {% if total_paginas > 1 %}

        {% set bloque = ((pagina - 1) // 10) %}
        {% set inicio = bloque * 10 + 1 %}
        {% set fin = inicio + 9 %}
        {% if fin > total_paginas %}
            {% set fin = total_paginas %}
        {% endif %}

        {% if inicio > 1 %}
            <a href="{{ url_for('servicios.servicios',
                pagina=inicio-10,
                q=q,
                id_negocio=id_negocio
            ) }}">¬´</a>
        {% endif %}

        {% for p in range(inicio, fin + 1) %}
            {% if p == pagina %}
                <strong>{{ p }}</strong>
            {% else %}
                <a href="{{ url_for('servicios.servicios',
                    pagina=p,
                    q=q,
                    id_negocio=id_negocio
                ) }}">{{ p }}</a>
            {% endif %}
        {% endfor %}

        {% if fin < total_paginas %}
            <a href="{{ url_for('servicios.servicios',
                pagina=inicio+10,
                q=q,
                id_negocio=id_negocio
            ) }}">¬ª</a>
        {% endif %}

    {% endif %}
</div>

{% endblock %}

{% block scripts %}
    <script src="{{ url_for('static', filename='js/servicios.js') }}"></script>
{% endblock %}