{% extends "base.html" %}

{% block content %}
<h1 id="tituloNuevaVenta">üßæ Nueva venta</h1>


<div id="modalCliente" class="modal" style="display:none;">
    <div class="modal-content">
        <span class="close" onclick="cerrarModalCliente()">&times;</span>
        <h2>Nuevo cliente</h2>

        <div id="errorClienteNuevo" 
            style="display:none; color:#b00020; background:#ffe5e5; 
                    padding:8px 12px; border-radius:6px; margin-bottom:10px; font-size:0.9em;">
        </div>


        <form id="formNuevoCliente" class="modal-form">

            <div class="modal-field">
                <label for="cliente_nombre">Nombre</label>
                <input id="cliente_nombre" type="text" name="nombre" required>
            </div>

            <div class="modal-field">
                <label for="cliente_apellido">Apellido</label>
                <input id="cliente_apellido" type="text" name="apellido" required>
            </div>

            <div class="modal-field">
                <label for="cliente_telefono">Tel√©fono</label>
                <input id="cliente_telefono" type="text" name="telefono" required pattern="[0-9]{10}" title="Debe contener 10 d√≠gitos">
            </div>

            <div class="modal-field">
                <label for="cliente_correo">Correo (opcional)</label>
                <input id="cliente_correo" type="email" name="correo">
            </div>

            <div class="modal-field">
                <label for="cliente_cp">C√≥digo postal (opcional)</label>
                <input id="cliente_cp" type="text" name="codigo_postal">
            </div>

            <button type="submit" class="btn-guardar-modal">
                Guardar cliente
            </button>

        </form>

    </div>
</div>

<form method="POST" action="/ventas/guardar" id="formVenta">
    <input type="hidden" name="id_cliente" id="id_cliente">

    <div class="venta-section">
        <div class="section-header">
            <h2>Cliente</h2>
        </div>
        <div id="busquedaCliente">
            <div class="search-form">
                <input
                    type="text"
                    id="buscarCliente"
                    placeholder="Nombre del cliente"
                    autocomplete="off"
                >
                <button type="button" id="btnNuevoCliente">‚ûï Nuevo cliente</button>
            </div>
            <div class="results-list" id="listaClientes"></div>
        </div>
        <div id="clienteBox" style="display:none;">
            <strong id="clienteSeleccionado"></strong>
            <button type="button" id="btnCambiarCliente">Cambiar cliente</button>
        </div>
    </div>

    <hr>

    <div class="venta-section">
        <div class="section-header">
            <h2>Negocio y fecha</h2>
        </div>
        <div class="form-group form-row">
            <div class="form-item">
                <label class="form-label">Negocio</label>
                <select name="id_negocio" id="id_negocio" onchange="seleccionarNegocio()">
                    <option value="">-- Selecciona --</option>
                    <option value="1">Fresh Steps</option>
                    <option value="2">Confecci√≥n</option>
                    <option value="3">Maquila</option>
                </select>

                <div id="errorNegocio" style="color:red; font-size:0.9em; display:none;">
                    No puedes cambiar el negocio si ya agregaste art√≠culos. Borra todos primero.
                </div>
            </div>

            <div class="form-item">
                <label class="form-label">Fecha y hora estimada</label>

                <div style="display:flex; gap:10px;">
                    <input
                        type="date"
                        id="fecha_estimada_fecha"
                        onchange="validarFormulario(); actualizarFechaEstimadaCompleta(); "
                        style="flex:1;"
                    >

                    <input
                        type="time"
                        id="fecha_estimada_hora"
                        onchange="validarFormulario(); actualizarFechaEstimadaCompleta(); "
                        style="width:120px;"
                    >
                </div>

                <input type="hidden" name="fecha_estimada" id="fecha_estimada">


                <div id="errorFecha" style="color:red; font-size:0.9em; display:none;">
                    La fecha estimada no puede ser menor a hoy.
                </div>
            </div>
        </div>
    </div>


    <hr>

    <div class="venta-section">    
        <div class="section-header">
            <h2>Art√≠culos</h2>
        </div>
        <div id="articulosContainer"></div>
        <button type="button" onclick="agregarArticulo()">‚ûï Agregar Art√≠culo</button>
    </div>

    <hr>

    <div class="venta-section">
        <div class="section-header">
            <h2>Pago y descuentos</h2>
        </div>
        <div class="pago-grid">

    <!-- FILA PREPAGO -->
    <div class="pago-row">
        <div class="form-item">
            <label class="form-label">¬øPrepago?</label>
            <select name="prepago" id="prepago"
                    onchange="togglePrepago(); validarFormulario(); actualizarTotal()">
                    <option value="no" selected>No</option>
                <option value="si">S√≠</option>
            </select>
        </div>

        <div class="form-item" id="tipoPagoPrepagoContainer" style="display:none;">
            <label class="form-label">Tipo de pago</label>
            <select name="tipo_pago" id="tipo_pago"
                    onchange="validarFormulario(); actualizarTotal()">
                <option value="">-- Selecciona --</option>
                <option value="efectivo">Efectivo</option>
                <option value="tarjeta">Tarjeta</option>
                <option value="transferencia">Transferencia</option>
            </select>
        </div>

        <div class="form-item" id="montoPrepagoContainer" style="display:none;">
            <label class="form-label">Monto prepago</label>
            <input type="number" min="0" step="0.01"
                   name="monto_prepago" id="monto_prepago"
                   placeholder="0"
                   oninput="validarFormulario(); actualizarTotal()">
            <div id="errorPrepago" class="error-msg" style="display:none;">
                El prepago no puede ser mayor al total ni menor a 0.
            </div>
        </div>
    </div>

    <div class="pago-row">
        <div class="form-item">
            <label class="form-label">¬øAplicar descuento?</label>
                <select name="aplica_descuento" id="aplica_descuento"
                        onchange="toggleDescuento(); actualizarTotal()">
                    <option value="no" selected>No</option>
                    <option value="si">S√≠</option>
                </select>
        </div>

        <div class="form-item" id="cantidadDescuentoContainer" style="display:none;">
            <label class="form-label">Descuento ($)</label>
            <input type="number" min="0" step="0.01"
                   name="cantidad_descuento" id="cantidad_descuento"
                   placeholder="0"
                   oninput="validarFormulario(); actualizarTotal()">
            <div id="errorDescuento" class="error-msg" style="display:none;">
                El descuento no puede ser mayor al total.
            </div>

        </div>
    </div>

</div>

    </div>

    <hr>

    <div class="form-group form-row total-row">
        <div id="totalVenta" class="total-amount">
            Total: $0.00
        </div>

        <div style="margin-left:auto; text-align:right;">
            <button type="submit" id="btnCrear" disabled>
                Crear recibo
            </button>

            <div id="mensajeBloqueo" class="mensaje-bloqueo"></div>

        </div>
    </div>

</form>

<script>
let contadorArticulos = 0;
let serviciosGlobales = [];
let negocioSeleccionado = "";

document.addEventListener("DOMContentLoaded", () => {
    document.getElementById("buscarCliente").addEventListener("input", buscarClientes);

    document.getElementById("btnCambiarCliente").addEventListener("click", () => {
        document.getElementById("id_cliente").value = "";
        document.getElementById("clienteSeleccionado").innerText = "";

        document.getElementById("clienteBox").style.display = "none";

        document.getElementById("busquedaCliente").style.display = "block";

        document.getElementById("buscarCliente").value = "";
        document.getElementById("listaClientes").innerHTML = "";

        validarFormulario();
    });

    document.getElementById("btnNuevoCliente").addEventListener("click", () => {
        document.getElementById("modalCliente").style.display = "block";
    });

    document.getElementById("formNuevoCliente").addEventListener("submit", crearCliente);

    document.getElementById("formVenta").addEventListener("submit", async function(e) {
        e.preventDefault();

        const form = e.target;
        const formData = new FormData(form);


        const nuevaPestana = window.open("", "_blank");

        try {
            const res = await fetch("/ventas/guardar", {
                method: "POST",
                body: formData
            });

            const data = await res.json();

            if (!data.ok) {
                nuevaPestana.close();
                alert("‚ùå Error: " + (data.error || "No se pudo guardar la venta"));
                return;
            }

            nuevaPestana.location.href = `/ventas/ticket/${data.id_venta}`;

            window.location.href = "/ventas/pendientes";

        } catch (err) {
            nuevaPestana.close();
            alert("‚ùå Error inesperado al guardar la venta.");
            console.error(err);
        }
    });


    document.getElementById("clienteBox").style.display = "none";
    document.getElementById("busquedaCliente").style.display = "block";

    window.addEventListener("click", function(event) {
        const modal = document.getElementById("modalCliente");
        if (event.target === modal) {
            cerrarModalCliente();
        }
    });

    bloquearFechaMinima();
    togglePrepago();
    toggleDescuento();
    validarFormulario();
});


function bloquearFechaMinima() {
    const input = document.getElementById("fecha_estimada_fecha");
    const hoy = new Date();
    const yyyy = hoy.getFullYear();
    const mm = String(hoy.getMonth() + 1).padStart(2, "0");
    const dd = String(hoy.getDate()).padStart(2, "0");
    const todayStr = `${yyyy}-${mm}-${dd}`;
    input.min = todayStr;
}

async function buscarClientes() {
    const q = this.value.trim();
    const lista = document.getElementById("listaClientes");
    lista.innerHTML = "";
    if (q.length < 2) return;

    const res = await fetch(`/api/clientes?q=${q}`);
    const clientes = await res.json();

    clientes.forEach(c => {
        const item = document.createElement("div");
        item.className = "result-item";
        item.innerHTML = `
            <div class="result-name">${c.nombre} ${c.apellido}</div>
            <div class="result-action">Seleccionar ‚Üí</div>
        `;
        item.onclick = () => seleccionarCliente(c);
        lista.appendChild(item);
    });
}

function seleccionarCliente(cliente) {
    document.getElementById("id_cliente").value = cliente.id_cliente;
    document.getElementById("clienteSeleccionado").innerText =
        `Cliente: ${cliente.nombre} ${cliente.apellido}`;
    document.getElementById("listaClientes").innerHTML = "";

    document.getElementById("clienteBox").style.display = "flex";

    document.getElementById("busquedaCliente").style.display = "none";

    validarFormulario();
}

function cerrarModalCliente() {
    const modal = document.getElementById("modalCliente");
    modal.style.display = "none";

    document.getElementById("formNuevoCliente").reset();
}


async function crearCliente(e) {
    e.preventDefault();

    const nombre = document.getElementById("cliente_nombre").value.trim();
    const apellido = document.getElementById("cliente_apellido").value.trim();
    const telefono = document.getElementById("cliente_telefono").value.trim();
    const errorBox = document.getElementById("errorClienteNuevo");

    if (!nombre || !apellido || !telefono) {
        errorBox.innerText = "Nombre, apellido y tel√©fono son obligatorios.";
        errorBox.style.display = "block";
        return;
    }

    if (!/^\d{10}$/.test(telefono)) {
        errorBox.innerText = "El tel√©fono debe contener exactamente 10 d√≠gitos.";
        errorBox.style.display = "block";
        return;
    }

    errorBox.style.display = "none";

    const formData = new FormData(e.target);

    const res = await fetch("/api/clientes/crear", {
        method: "POST",
        body: formData
    });

    if (!res.ok) {
        errorBox.innerText = "‚ùå Error al crear el cliente.";
        errorBox.style.display = "block";
        return;
    }

    const cliente = await res.json();

    cerrarModalCliente();
    seleccionarCliente(cliente);
}


async function cargarServicios() {
    const idNegocio = document.getElementById("id_negocio").value;

    if (!idNegocio) {
        serviciosGlobales = [];
        return;
    }

    const res = await fetch(`/api/servicios?id_negocio=${idNegocio}`);
    serviciosGlobales = await res.json();
}

async function seleccionarNegocio() {
    const select = document.getElementById("id_negocio");
    const nuevoNegocio = select.value;

    const hayArticulos = document.querySelectorAll(".articulo-item").length > 0;

    if (hayArticulos && negocioSeleccionado && nuevoNegocio !== negocioSeleccionado) {
        select.value = negocioSeleccionado;
        document.getElementById("errorNegocio").style.display = "block";
        return;
    }

    document.getElementById("errorNegocio").style.display = "none";
    negocioSeleccionado = nuevoNegocio;

    await cargarServicios();

    if (!hayArticulos) {
        document.getElementById("articulosContainer").innerHTML = "";
        contadorArticulos = 0;
        actualizarTotal();
        validarFormulario();
    }
}

function agregarArticulo() {
    const idNegocio = document.getElementById("id_negocio").value;
    if (!idNegocio) {
        alert("Primero selecciona un negocio.");
        return;
    }

    const index = contadorArticulos;
    const tipoArticulo = obtenerTipoArticuloPorNegocio(idNegocio);

    const div = document.createElement("div");
    div.className = "articulo-item";
    div.innerHTML = `
        <div class="zapato-header">
            <div class="zapato-titulo">üßæ Art√≠culo ${index + 1}</div>
            <button type="button" class="btn-eliminar-zapato" onclick="eliminarArticulo(this)">‚úï</button>
        </div>

        <input type="hidden" name="articulos[${index}][tipo_articulo]" value="${tipoArticulo}">

        ${crearCamposArticulo(index, tipoArticulo)}
    `;

    document.getElementById("articulosContainer").appendChild(div);
    contadorArticulos++;

    actualizarOpcionesServiciosDelArticulo(index);
    validarFormulario();
    actualizarTotal();
}

function eliminarArticulo(btn) {
    btn.closest(".articulo-item").remove();
    renumerarArticulos();
    validarFormulario();
    actualizarTotal();
}

function renumerarArticulos() {
    document.querySelectorAll(".articulo-item").forEach((item, i) => {
        item.querySelector(".zapato-titulo").innerText = `üßæ Art√≠culo ${i + 1}`;
    });
    contadorArticulos = document.querySelectorAll(".articulo-item").length;

    if (contadorArticulos === 0) {
        document.getElementById("errorNegocio").style.display = "none";
    }
}

function obtenerTipoArticuloPorNegocio(idNegocio) {
    if (idNegocio === "1") return "calzado";
    if (idNegocio === "2") return "confeccion";
    if (idNegocio === "3") return "maquila";
    return "";
}

function inputConLabel(label, name, placeholder = "", required = false, type = "text", extra = "") {
    return `
        <div class="campo-item">
            <label class="form-label">${label}</label>
            <input 
                type="${type}" 
                name="${name}" 
                placeholder="${placeholder}" 
                ${required ? "required" : ""} 
                ${extra}
                oninput="validarFormulario(); actualizarTotal()"
            >
        </div>
    `;
}


function crearCamposArticulo(index, tipoArticulo) {
    if (tipoArticulo === "calzado") {
        return `
            <div class="form-group form-row articulo-row">
                ${inputConLabel("Tipo", `articulos[${index}][tipo]`, "Tenis, Bota...", true)}
                ${inputConLabel("Marca", `articulos[${index}][marca]`, "Nike, Puma...", true)}
                ${inputConLabel("Material", `articulos[${index}][material]`, "Gamuza, Piel...", true)}
                ${inputConLabel("Color base", `articulos[${index}][color_base]`, "Negro, Blanco...", true)}
                ${inputConLabel("Color secundario (Opcional)", `articulos[${index}][color_secundario]`, "Negro, Blanco...", false)}
                ${inputConLabel("Color agujetas (Opcional)", `articulos[${index}][color_agujetas]`, "Negro, Blanco...", false)}
            </div>

            ${crearServiciosSelect(index)}

            ${inputConLabel("Comentario", `articulos[${index}][comentario]`, "(opcional)", false)}
        `;
    }

    if (tipoArticulo === "confeccion") {
        return `
            <div class="form-group form-row articulo-row">
                ${inputConLabel("Tipo", `articulos[${index}][tipo]`, "Pantal√≥n, Falda...", true)}
                ${inputConLabel("Marca", `articulos[${index}][marca]`, "Zara, Levis...", true)}
                ${inputConLabel("Material", `articulos[${index}][material]`, "Mezclilla, Gamuza...", true)}
                ${inputConLabel("Color base", `articulos[${index}][color_base]`, "Negro, Blanco...", true)}
                ${inputConLabel("Color secundario (Opcional)", `articulos[${index}][color_secundario]`, "Negro, Blanco...", false)}
                ${inputConLabel("Cantidad", `articulos[${index}][cantidad]`, "1,2...", true, "number", `min="1"`)}

            </div>

            ${crearServiciosSelect(index)}

            ${inputConLabel("Comentario", `articulos[${index}][comentario]`, "(opcional)", false)}
        `;
    }

    return `
        <div class="form-group form-row articulo-row">
            ${inputConLabel("Tipo", `articulos[${index}][tipo]`, "Mandil, Bata...", true)}
            ${inputConLabel("Cantidad", `articulos[${index}][cantidad]`, "1,2...", true, "number", `min="1"`)}

            ${inputConLabel("Precio unitario", `articulos[${index}][precio_unitario]`, "$10.00", true, "number", `min="0"`)}

        </div>

        ${inputConLabel("Comentario", `articulos[${index}][comentario]`, "(opcional)", false)}
    `;
}

function crearServiciosSelect(indexArticulo) {
    let opciones = `<option value="">-- Selecciona servicio --</option>`;
    serviciosGlobales.forEach(s => {
        const precio = s.precio_base ?? s.precio ?? 0;
        opciones += `<option value="${s.id_servicio}" data-precio="${precio}">
            ${s.nombre} ($${precio})
        </option>`;
    });

    return `
        <div class="form-group servicios-box" data-articulo="${indexArticulo}">
            
            <div class="servicios-header">
                <label class="form-label">Servicios</label>

                <button type="button" class="btn-agregar-servicio"
                        onclick="agregarServicio(${indexArticulo})">
                    ‚ûï Agregar servicio
                </button>
            </div>

            <div class="servicios-lista" id="serviciosLista_${indexArticulo}">
                ${crearFilaServicio(indexArticulo, 0, opciones)}
            </div>
        </div>
    `;
}

function crearFilaServicio(indexArticulo, indexServicio, opcionesHTML) {
    return `
        <div class="servicio-item" data-index-servicio="${indexServicio}"
             style="display:flex; gap:10px; align-items:center; margin-bottom:8px;">

            <select name="articulos[${indexArticulo}][servicios][${indexServicio}][id_servicio]"
                    onchange="onChangeServicio(this, ${indexArticulo}); validarFormulario(); actualizarTotal()">
                ${opcionesHTML}
            </select>

            <input type="number"
                   min="0"
                   step="0.01"
                   class="precio-aplicado"
                   name="articulos[${indexArticulo}][servicios][${indexServicio}][precio_aplicado]"
                   placeholder="Precio aplicado"
                   value=""
                   disabled
                   data-editado="0"
                   oninput="marcarPrecioEditado(this); validarFormulario(); actualizarTotal()"
                   style="width:150px;">

            <button type="button" onclick="eliminarServicioPro(this, ${indexArticulo})"
                    style="padding:6px 10px;">
                ‚úï
            </button>
        </div>
    `;
}

function marcarPrecioEditado(input) {
    input.dataset.editado = "1";
}

function agregarServicio(indexArticulo) {
    const contenedor = document.getElementById(`serviciosLista_${indexArticulo}`);

    let opciones = `<option value="">-- Selecciona servicio --</option>`;
    serviciosGlobales.forEach(s => {
        const precio = s.precio_base ?? s.precio ?? 0;
        opciones += `<option value="${s.id_servicio}" data-precio="${precio}">
            ${s.nombre} ($${precio})
        </option>`;
    });

    const indexServicio = contenedor.querySelectorAll(".servicio-item").length;
    contenedor.insertAdjacentHTML("beforeend", crearFilaServicio(indexArticulo, indexServicio, opciones));

    actualizarOpcionesServiciosDelArticulo(indexArticulo);
    validarFormulario();
    actualizarTotal();
}

function eliminarServicioPro(btn, indexArticulo) {
    const fila = btn.closest(".servicio-item");
    const contenedor = fila.parentElement;

    fila.remove();

    if (contenedor.querySelectorAll(".servicio-item").length === 0) {
        let opciones = `<option value="">-- Selecciona servicio --</option>`;
        serviciosGlobales.forEach(s => {
            const precio = s.precio_base ?? s.precio ?? 0;
            opciones += `<option value="${s.id_servicio}" data-precio="${precio}">
                ${s.nombre} ($${precio})
            </option>`;
        });

        contenedor.insertAdjacentHTML("beforeend", crearFilaServicio(indexArticulo, 0, opciones));
    }

    actualizarOpcionesServiciosDelArticulo(indexArticulo);
    validarFormulario();
    actualizarTotal();
}

function onChangeServicio(select, indexArticulo) {
    const fila = select.closest(".servicio-item");
    const inputPrecio = fila.querySelector(".precio-aplicado");
    const opt = select.selectedOptions[0];

    if (!opt || !opt.value) {
        inputPrecio.value = "";
        inputPrecio.disabled = true;
        inputPrecio.dataset.editado = "0";
        actualizarOpcionesServiciosDelArticulo(indexArticulo);
        actualizarTotal(); 
        return;
    }

    inputPrecio.disabled = false;

    if (inputPrecio.dataset.editado !== "1") {
        inputPrecio.value = parseFloat(opt.dataset.precio || 0);
    }

    if (hayServicioRepetidoEnArticulo(indexArticulo)) {
        alert("‚ö†Ô∏è No puedes repetir el mismo servicio en el mismo art√≠culo.");
        select.value = "";
        inputPrecio.value = "";
        inputPrecio.disabled = true;
        inputPrecio.dataset.editado = "0";
    }

    actualizarOpcionesServiciosDelArticulo(indexArticulo);
    actualizarTotal(); 
}

function hayServicioRepetidoEnArticulo(indexArticulo) {
    const contenedor = document.getElementById(`serviciosLista_${indexArticulo}`);
    const selects = contenedor.querySelectorAll("select");

    const vistos = new Set();
    for (const sel of selects) {
        if (sel.value) {
            if (vistos.has(sel.value)) return true;
            vistos.add(sel.value);
        }
    }
    return false;
}

function actualizarOpcionesServiciosDelArticulo(indexArticulo) {
    const contenedor = document.getElementById(`serviciosLista_${indexArticulo}`);
    if (!contenedor) return;

    const selects = contenedor.querySelectorAll("select");

    const usados = new Set();
    selects.forEach(sel => {
        if (sel.value) usados.add(sel.value);
    });

    selects.forEach(sel => {
        const valorActual = sel.value;

        Array.from(sel.options).forEach(opt => {
            if (!opt.value) return;

            if (usados.has(opt.value) && opt.value !== valorActual) {
                opt.disabled = true;
            } else {
                opt.disabled = false;
            }
        });
    });
}

function togglePrepago() {
    const val = document.getElementById("prepago").value;
    const show = val === "si";

    document.getElementById("montoPrepagoContainer").style.display = show ? "block" : "none";
    document.getElementById("tipoPagoPrepagoContainer").style.display = show ? "block" : "none";

    if (!show) {
        document.getElementById("monto_prepago").value = "";
        document.getElementById("tipo_pago").value = "";
        document.getElementById("errorPrepago").style.display = "none";
    }
}



function toggleDescuento() {
    const val = document.getElementById("aplica_descuento").value;
    const container = document.getElementById("cantidadDescuentoContainer");
    const input = document.getElementById("cantidad_descuento");

    if (val === "si") {
        container.style.display = "block";
    } else {
        container.style.display = "none";
        input.value = "";
    }

    validarFormulario();
    actualizarTotal();
}


function articulosCompletos() {
    const articulos = document.querySelectorAll(".articulo-item");
    if (articulos.length === 0) return false;

    const negocio = document.getElementById("id_negocio").value;

    for (const art of articulos) {
        const campos = art.querySelectorAll("input, select, textarea");

        for (const campo of campos) {
            if (campo.offsetParent === null) continue;

            const name = campo.name || "";

            if (negocio === "1") {
                if (
                    name.includes("[color_secundario]") ||
                    name.includes("[color_agujetas]")
                ) {
                    continue;
                }
            }

            if (negocio === "2") {
                if (name.includes("[color_secundario]")) {
                    continue;
                }
            }

            if (campo.hasAttribute("required")) {
                if (!campo.value || campo.value.trim() === "") {
                    return false;
                }
            }
        }
    }

    return true;
}


function validarFormulario() {
    let valido = true;

    const cliente = document.getElementById("id_cliente").value;
    const negocio = document.getElementById("id_negocio").value;
    const fechaEstimada = document.getElementById("fecha_estimada").value;

    const prepago = document.getElementById("prepago").value;
    const tipoPago = document.getElementById("tipo_pago").value;
    const montoPrepago = parseFloat(document.getElementById("monto_prepago")?.value || 0);

    const aplicaDesc = document.getElementById("aplica_descuento").value === "si";
    const descuento = parseFloat(document.getElementById("cantidad_descuento")?.value || 0);


    /* ---------- Negocio y fecha ---------- */
    if (!negocio || !fechaEstimada) {
        valido = false;
    }

    /* ---------- Art√≠culos ---------- */
    const articulos = document.querySelectorAll(".articulo-item");
    if (articulos.length === 0 || !articulosCompletos()) {
        valido = false;
    }

    /* ---------- Servicios obligatorios ---------- */
    if (negocio === "1" || negocio === "2") {
        document.querySelectorAll(".servicios-box").forEach(box => {
            const selects = box.querySelectorAll("select");

            let cantidadSeleccionados = 0;
            let hayVacio = false;

            selects.forEach(sel => {
                if (sel.value && sel.value.trim() !== "") {
                    cantidadSeleccionados++;
                } else {
                    hayVacio = true;
                }
            });

            if (cantidadSeleccionados === 0 || hayVacio) {
                valido = false;
            }
        });
    }

    /* ---------- Prepago ---------- */
    if (prepago === "si") {
        if (!tipoPago || montoPrepago <= 0) {
            valido = false;
        }

        if (montoPrepago > calcularTotal()) {
            document.getElementById("errorPrepago").style.display = "block";
            valido = false;
        } else {
            document.getElementById("errorPrepago").style.display = "none";
        }
    } else {
        document.getElementById("errorPrepago").style.display = "none";
    }

    /* ---------- Descuento ---------- */
    if (aplicaDesc) {
        const totalBruto = calcularTotal(true);

        if (descuento <= 0 || descuento > totalBruto) {
            document.getElementById("errorDescuento").style.display = "block";
            valido = false;
        } else {
            document.getElementById("errorDescuento").style.display = "none";
        }
    } else {
        document.getElementById("errorDescuento").style.display = "none";
    }

    /* ---------- MENSAJE DE BLOQUEO ---------- */
    const motivos = obtenerMotivosBloqueo();
    const btn = document.getElementById("btnCrear");
    const msg = document.getElementById("mensajeBloqueo");

    btn.disabled = !valido || motivos.length > 0;

    if (motivos.length > 0) {
        msg.innerText = "Falta: " + motivos.join(" ¬∑ ");
        msg.style.display = "block";
    } else {
        msg.style.display = "none";
    }
}



function calcularTotal(bruto = false) {
    const negocio = document.getElementById("id_negocio").value;
    let total = 0;

    if (negocio === "1") {
        document.querySelectorAll(".servicio-item").forEach(fila => {
            const sel = fila.querySelector("select");
            const precio = fila.querySelector(".precio-aplicado");

            if (sel && sel.value) {
                total += parseFloat(precio?.value || 0);
            }
        });
    }

    if (negocio === "2") {
        document.querySelectorAll(".articulo-item").forEach(articulo => {
            const cantidad = parseFloat(
                articulo.querySelector("input[name$='[cantidad]']")?.value || 1
            );

            articulo.querySelectorAll(".servicio-item").forEach(fila => {
                const sel = fila.querySelector("select");
                const precio = fila.querySelector(".precio-aplicado");

                if (sel && sel.value) {
                    total += cantidad * parseFloat(precio?.value || 0);
                }
            });
        });
    }

    if (negocio === "3") {
        document.querySelectorAll(".articulo-item").forEach(item => {
            const cantidad = parseFloat(
                item.querySelector("input[name$='[cantidad]']")?.value || 0
            );
            const precio = parseFloat(
                item.querySelector("input[name$='[precio_unitario]']")?.value || 0
            );

            total += cantidad * precio;
        });
    }

    if (bruto) return total; 

    const aplicaDesc = document.getElementById("aplica_descuento").value === "si";
    const desc = parseFloat(document.getElementById("cantidad_descuento")?.value || 0);

    if (aplicaDesc && desc > 0) {
        total -= desc;
        if (total < 0) total = 0;
    }

    return total;
}



function actualizarTotal() {
    const total = calcularTotal();
    document.getElementById("totalVenta").innerText = `Total: $${total.toLocaleString("es-MX", { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
}

function actualizarFechaEstimadaCompleta() {
    const fecha = document.getElementById("fecha_estimada_fecha").value;
    const hora = document.getElementById("fecha_estimada_hora").value;

    if (fecha && hora) {
        document.getElementById("fecha_estimada").value = `${fecha} ${hora}:00`;
    } else {
        document.getElementById("fecha_estimada").value = "";
    }
}


function obtenerMotivosBloqueo() {
    const motivos = [];

    if (!document.getElementById("id_cliente").value) {
        motivos.push("Seleccionar un cliente");
    }

    if (!document.getElementById("id_negocio").value) {
        motivos.push("Eligir un negocio");
    }

    if (!document.getElementById("fecha_estimada").value) {
        motivos.push("Definir fecha y hora");
    }

    const articulos = document.querySelectorAll(".articulo-item");
    if (articulos.length === 0) {
        motivos.push("Agregar al menos un art√≠culo");
    } else if (!articulosCompletos()) {
        motivos.push("Completar los datos de los art√≠culos");
    }

    const prepago = document.getElementById("prepago").value;
    if (prepago === "si") {
        const tipoPago = document.getElementById("tipo_pago").value;
        const monto = parseFloat(document.getElementById("monto_prepago").value || 0);

        if (!tipoPago) {
            motivos.push("Seleccionar el tipo de pago");
        }
        if (monto <= 0) {
            motivos.push("Ingresar un monto de prepago v√°lido");
        }
        if (monto > calcularTotal()) {
            motivos.push("El prepago supera el total");
        }
    }

    const aplicaDesc = document.getElementById("aplica_descuento").value === "si";
    if (aplicaDesc) {
        const desc = parseFloat(document.getElementById("cantidad_descuento").value || 0);
        const totalBruto = calcularTotal(true);

        if (desc <= 0) {
            motivos.push("El descuento debe ser mayor a 0");
        } else if (desc > totalBruto) {
            motivos.push("El descuento supera el total");
        }
    }

    return motivos;
}



</script>

{% endblock %}