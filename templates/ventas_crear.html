{% extends "base.html" %}

{% block content %}
<h1 id="tituloNuevaVenta">ðŸ§¾ Nueva venta</h1>

<div id="busquedaCliente">
    <form class="search-form" onsubmit="return false;">
        <input
            type="text"
            id="buscarCliente"
            placeholder="Nombre del cliente"
            autocomplete="off"
        >
        <button type="button" id="btnNuevoCliente">âž• Nuevo cliente</button>
    </form>

    <div class="results-list" id="listaClientes"></div>
</div>

<hr>

<div id="modalCliente" class="modal" style="display:none;">
    <div class="modal-content">
        <span class="close" onclick="cerrarModalCliente()">&times;</span>
        <h2>Nuevo cliente</h2>

        <form id="formNuevoCliente">
            <input type="text" name="nombre" placeholder="Nombre" required>
            <input type="text" name="apellido" placeholder="Apellido" required>
            <input type="email" name="correo" placeholder="Correo">
            <input type="text" name="telefono" placeholder="TelÃ©fono">
            <input type="text" name="direccion" placeholder="DirecciÃ³n">

            <button type="submit">Guardar</button>
        </form>
    </div>
</div>



<form method="POST" action="/ventas/guardar" id="formVenta" style="display:none;">
    <input type="hidden" name="id_cliente" id="id_cliente">

    <div id="clienteBox">
        <strong id="clienteSeleccionado"></strong>
        <button type="button" id="btnCambiarCliente">Cambiar cliente</button>
    </div>

    <hr>


    <div id="zapatosContainer"></div>
    <button type="button" onclick="agregarZapato()">âž• Agregar Articulo</button>

    <hr>

    <div class="form-group">
        <label class="form-label">Tipo de pago</label>
        <select name="tipo_pago" id="tipo_pago" onchange="validarFormulario()">
            <option value="">-- Selecciona --</option>
            <option value="efectivo">Efectivo</option>
            <option value="tarjeta">Tarjeta</option>
        </select>
    </div>

    <div class="form-group prepago-row">
    <div>
        <label class="form-label">Â¿Prepago?</label>
        <select name="prepago" id="prepago" onchange="togglePrepago()">
            <option value="">-- Selecciona --</option>
            <option value="si">SÃ­</option>
            <option value="no">No</option>
        </select>
    </div>

    <div id="montoPrepagoContainer">
        <label class="form-label">Monto prepago</label>
        <input
            type="number"
            step="0.01"
            name="monto_prepago"
            id="monto_prepago"
            placeholder="$0.00"
            oninput="validarFormulario()"
        >
        <div id="errorPrepago" style="color:red; font-size:0.9em; display:none;">
            El prepago no puede ser mayor al total de la venta.
        </div>
    </div>
</div>
    

    

    <div id="totalVenta" style="font-weight:bold; font-size:1.2em;">
        Total: $0.00
    </div>

    <button type="submit" id="btnCrear" disabled>Crear recibo</button>
</form>




<script>
let contadorZapatos = 0;
let serviciosGlobales = [];
let zapatosCliente = [];


document.addEventListener("DOMContentLoaded", async () => {
    await cargarServicios();

    document.getElementById("buscarCliente")
        .addEventListener("input", buscarClientes);

    document.getElementById("btnCambiarCliente")
        .addEventListener("click", () => location.reload());

    document.getElementById("btnNuevoCliente")
        .addEventListener("click", () => {
            document.getElementById("modalCliente").style.display = "block";
        });

    document.getElementById("formNuevoCliente")
        .addEventListener("submit", crearCliente);
});


async function buscarClientes() {
    const q = this.value.trim();
    const lista = document.getElementById("listaClientes");
    lista.innerHTML = "";

    if (q.length < 2) return;

    const res = await fetch(`/api/clientes?q=${q}`);
    const clientes = await res.json();

    clientes.forEach(c => {
        const item = document.createElement("div");
        item.className = "result-item";
        item.innerHTML = `
            <div class="result-name">${c.nombre} ${c.apellido}</div>
            <div class="result-action">Seleccionar â†’</div>
        `;
        item.onclick = () => seleccionarCliente(c);
        lista.appendChild(item);
    });
}


function seleccionarCliente(cliente) {
    document.getElementById("id_cliente").value = cliente.id_cliente;
    document.getElementById("clienteSeleccionado").innerText =
        `Cliente: ${cliente.nombre} ${cliente.apellido}`;

    document.getElementById("tituloNuevaVenta").style.display = "none";
    document.getElementById("busquedaCliente").style.display = "none";
    document.getElementById("listaClientes").innerHTML = "";
    document.getElementById("formVenta").style.display = "block";

    cargarZapatosCliente(cliente.id_cliente);
    validarFormulario();
}

function cerrarModalCliente() {
    document.getElementById("modalCliente").style.display = "none";
}


async function crearCliente(e) {
    e.preventDefault();

    const formData = new FormData(e.target);

    const res = await fetch("/api/clientes/crear", {
        method: "POST",
        body: formData
    });

    const cliente = await res.json();

    cerrarModalCliente();
    seleccionarCliente(cliente);
}


async function cargarServicios() {
    const res = await fetch("/api/servicios");
    serviciosGlobales = await res.json();
}

async function cargarZapatosCliente(idCliente) {
    const res = await fetch(`/api/clientes/${idCliente}/zapatos`);
    zapatosCliente = await res.json();
}


function agregarZapato() {
    const index = contadorZapatos;

    const div = document.createElement("div");
    div.className = "zapato-item";
    div.innerHTML = `
        <div class="zapato-header">
            <div class="zapato-titulo">ðŸ§¾ ArtÃ­culo ${index + 1}</div>
            <button type="button" class="btn-eliminar-zapato"
                onclick="eliminarZapato(this)">âœ•</button>
        </div>

        ${crearSelectZapatos(index)}
        ${crearSelectServicios(index)}
    `;

    document.getElementById("zapatosContainer").appendChild(div);
    contadorZapatos++;
    validarFormulario();
}

function eliminarZapato(btn) {
    btn.closest(".zapato-item").remove();
    renumerarArticulos();
    validarFormulario();
}

function renumerarArticulos() {
    document.querySelectorAll(".zapato-item").forEach((item, i) => {
        item.querySelector(".zapato-titulo").innerText = `ðŸ§¾ ArtÃ­culo ${i + 1}`;
    });
    contadorZapatos = document.querySelectorAll(".zapato-item").length;
}


function crearSelectZapatos(index) {
    let opciones = `<option value="">Selecciona zapato</option>`;
    zapatosCliente.forEach(z => {
        opciones += `
            <option value="${z.id_zapato}">
                ${z.marca} / ${z.tipo} / ${z.material} / ${z.color_base}-${z.color_secundario}
            </option>`;
    });

    return `
        <select name="zapatos[${index}][id_zapato]" onchange="validarFormulario()">
            ${opciones}
        </select>`;
}

function crearSelectServicios(index) {
    let opciones = `<option value="">Selecciona servicio</option>`;
    serviciosGlobales.forEach(s => {
        opciones += `
            <option value="${s.id_servicio}">
                ${s.nombre} ($${s.precio})
            </option>`;
    });

    return `
        <select name="zapatos[${index}][id_servicio]" onchange="validarFormulario(); actualizarTotal()">
            ${opciones}
        </select>`;
}


function togglePrepago() {
    const val = document.getElementById("prepago").value;
    document.getElementById("montoPrepagoContainer").style.display =
        val === "si" ? "block" : "none";
    validarFormulario();
}

document.getElementById("monto_prepago")?.addEventListener("input", actualizarTotal);



function validarFormulario() {
    const cliente = document.getElementById("id_cliente").value;
    const tipoPago = document.getElementById("tipo_pago").value;
    const prepago = document.getElementById("prepago").value;
    const monto = parseFloat(document.getElementById("monto_prepago")?.value || 0);

    let valido = cliente && tipoPago && prepago;

    const selects = document.querySelectorAll("#zapatosContainer select");
    if (selects.length === 0) valido = false;

    selects.forEach(s => {
        if (!s.value) valido = false;
    });

    let total = 0;
    document.querySelectorAll("#zapatosContainer select[name$='[id_servicio]']").forEach(select => {
        const idServicio = select.value;
        if (idServicio) {
            const servicio = serviciosGlobales.find(s => s.id_servicio == idServicio);
            if (servicio) total += parseFloat(servicio.precio);
        }
    });

    if (prepago === "si") {
        if (!monto || monto <= 0) {
            valido = false;
        }
        if (monto > total) {
            valido = false;
            document.getElementById("errorPrepago").style.display = "block";
        } else {
            document.getElementById("errorPrepago").style.display = "none";
        }
    } else {
        document.getElementById("errorPrepago").style.display = "none";
    }

    document.getElementById("btnCrear").disabled = !valido;
}


function actualizarTotal() {
    let total = 0;

    document.querySelectorAll("#zapatosContainer select[name$='[id_servicio]']").forEach(select => {
        const idServicio = select.value;
        if (idServicio) {
            const servicio = serviciosGlobales.find(s => s.id_servicio == idServicio);
            if (servicio) total += parseFloat(servicio.precio);
        }
    });

    document.getElementById("totalVenta").innerText = `Total: $${total.toFixed(2)}`;
}


</script>

{% endblock %}
