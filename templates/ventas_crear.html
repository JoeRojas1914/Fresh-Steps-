{% extends "base.html" %}

{% block content %}
<h1 id="tituloNuevaVenta">Nueva venta</h1>

<div id="busquedaCliente">
    <form class="search-form" onsubmit="return false;">
        <input
            type="text"
            id="buscarCliente"
            placeholder="Nombre del cliente"
            autocomplete="off"
        >
        <button type="button" id="btnNuevoCliente">➕ Nuevo cliente</button>
    </form>

    <div class="results-list" id="listaClientes"></div>
</div>

<div id="modalCliente" class="modal" style="display:none;">
    <div class="modal-content">
        <span class="close" onclick="cerrarModalCliente()">&times;</span>
        <h2>Nuevo cliente</h2>

        <form id="formNuevoCliente">
            <input type="text" name="nombre" placeholder="Nombre" required>
            <input type="text" name="apellido" placeholder="Apellido" required>
            <input type="email" name="correo" placeholder="Correo">
            <input type="text" name="telefono" placeholder="Teléfono">
            <input type="text" name="direccion" placeholder="Dirección">

            <button type="submit">Guardar</button>
        </form>
    </div>
</div>



<form method="POST" action="/ventas/guardar" id="formVenta" style="display:none;">
    <input type="hidden" name="id_cliente" id="id_cliente">

    <div id="clienteBox">
        <strong id="clienteSeleccionado"></strong>
        <button type="button" id="btnCambiarCliente">Cambiar cliente</button>
    </div>

    <hr>

    <div id="zapatosContainer"></div>
    <button type="button" onclick="agregarZapato()">➕ Agregar Articulo</button>

    <hr>

    <label>Tipo de pago</label>
    <select name="tipo_pago" id="tipo_pago" onchange="validarFormulario()">
        <option value="">-- Selecciona --</option>
        <option value="efectivo">Efectivo</option>
        <option value="tarjeta">Tarjeta</option>
    </select>

  <br>    

    <label>¿Prepago?</label>
    <select name="prepago" id="prepago" onchange="togglePrepago()">
        <option value="">-- Selecciona --</option>
        <option value="si">Sí</option>
        <option value="no">No</option>
    </select>

    <div id="montoPrepagoContainer" style="display:none;">
        <input type="number" step="0.01" name="monto_prepago" id="monto_prepago">
    </div>
  <br>    

    

    <button type="submit" id="btnCrear" disabled>Crear recibo</button>
</form>




<script>
let contadorZapatos = 0;

document.getElementById("buscarCliente").addEventListener("input", async function () {
    const q = this.value.trim();
    const lista = document.getElementById("listaClientes");
    lista.innerHTML = "";

    if (q.length < 2) return;

    const res = await fetch(`/api/clientes?q=${q}`);
    const clientes = await res.json();

    clientes.forEach(c => {
        const item = document.createElement("div");
        item.className = "result-item";
        item.style.cursor = "pointer";

        item.innerHTML = `
            <div class="result-name">
                ${c.nombre} ${c.apellido}
            </div>
            <div class="result-action">
                Seleccionar →
            </div>
        `;

        item.onclick = () => seleccionarCliente(c);
        lista.appendChild(item);
    });

});

function seleccionarCliente(cliente) {
    document.getElementById("id_cliente").value = cliente.id_cliente;
    document.getElementById("clienteSeleccionado").innerText =
        `Cliente: ${cliente.nombre} ${cliente.apellido}`;

    document.getElementById("tituloNuevaVenta").style.display = "none";
    document.getElementById("busquedaCliente").style.display = "none";
    document.getElementById("listaClientes").innerHTML = "";
    document.getElementById("formVenta").style.display = "block";

    validarFormulario();
}

document.getElementById("btnCambiarCliente").addEventListener("click", () => {
    location.reload();
});

document.getElementById("btnNuevoCliente").addEventListener("click", () => {
    document.getElementById("modalCliente").style.display = "block";
});
function cerrarModalCliente() {
    document.getElementById("modalCliente").style.display = "none";
}

function agregarZapato() {
    const div = document.createElement("div");
    div.innerHTML = `
        <select name="zapatos[${contadorZapatos}][id_zapato]" onchange="validarFormulario()">
            <option value="">Zapato</option>
            {% for z in zapatos %}
            <option value="{{ z.id_zapato }}">{{ z.color_base }} - {{ z.material }}</option>
            {% endfor %}
        </select>

        <select name="zapatos[${contadorZapatos}][id_servicio]" onchange="validarFormulario()">
            <option value="">Servicio</option>
            {% for s in servicios %}
            <option value="{{ s.id_servicio }}">{{ s.nombre }} (${{ s.precio }})</option>
            {% endfor %}
        </select>
        <hr>
    `;
    document.getElementById("zapatosContainer").appendChild(div);
    contadorZapatos++;
}

function togglePrepago() {
    const val = document.getElementById("prepago").value;
    document.getElementById("montoPrepagoContainer").style.display =
        val === "si" ? "block" : "none";
    validarFormulario();
}

function validarFormulario() {
    const cliente = document.getElementById("id_cliente").value;
    const tipoPago = document.getElementById("tipo_pago").value;
    const prepago = document.getElementById("prepago").value;
    const monto = document.getElementById("monto_prepago")?.value;

    let zapatosOK = contadorZapatos > 0;
    document.querySelectorAll("#zapatosContainer select").forEach(s => {
        if (!s.value) zapatosOK = false;
    });

    let valido = cliente && tipoPago && zapatosOK;

    if (prepago === "si") {
        valido = valido && monto && parseFloat(monto) > 0;
    }

    document.getElementById("btnCrear").disabled = !valido;
}

document.getElementById("formNuevoCliente").addEventListener("submit", async function (e) {
    e.preventDefault();

    const formData = new FormData(this);

    const res = await fetch("/api/clientes/crear", {
        method: "POST",
        body: formData
    });

    const cliente = await res.json();

    cerrarModalCliente();
    seleccionarCliente(cliente);
});

</script>





{% endblock %}
