{% extends "base.html" %}

{% block content %}
<h1 id="tituloNuevaVenta">ðŸ§¾ Nueva venta</h1>

<div id="busquedaCliente">
    <form class="search-form" onsubmit="return false;">
        <input
            type="text"
            id="buscarCliente"
            placeholder="Nombre del cliente"
            autocomplete="off"
        >
        <button type="button" id="btnNuevoCliente">âž• Nuevo cliente</button>
    </form>

    <div class="results-list" id="listaClientes"></div>
</div>

<hr>

<div id="modalCliente" class="modal" style="display:none;">
    <div class="modal-content">
        <span class="close" onclick="cerrarModalCliente()">&times;</span>
        <h2>Nuevo cliente</h2>

        <form id="formNuevoCliente">
            <input type="text" name="nombre" placeholder="Nombre" required>
            <input type="text" name="apellido" placeholder="Apellido" required>
            <input type="email" name="correo" placeholder="Correo">
            <input type="text" name="telefono" placeholder="TelÃ©fono">
            <input type="text" name="direccion" placeholder="DirecciÃ³n">

            <button type="submit">Guardar</button>
        </form>
    </div>
</div>


<div id="modalZapato" class="modal" style="display:none;">
    <div class="modal-content">
        <span class="close" onclick="cerrarModalZapato()">&times;</span>
        <h2>Nuevo calzado</h2>

        <form id="formNuevoZapato">
            <input type="hidden" name="id_cliente" id="id_cliente_modal">
            <input type="text" name="marca" placeholder="Marca" required>
            <input type="text" name="tipo" placeholder="Tipo" required>
            <input type="text" name="material" placeholder="Material" required>
            <input type="text" name="color_base" placeholder="Color base" required>
            <input type="text" name="color_secundario" placeholder="Color secundario" required>

            <button type="submit">Guardar</button>
        </form>
    </div>
</div>



<form method="POST" action="/ventas/guardar" id="formVenta" style="display:none;">
    <input type="hidden" name="id_cliente" id="id_cliente">

    <div id="clienteBox">
        <strong id="clienteSeleccionado"></strong>
        <button type="button" id="btnCambiarCliente">Cambiar cliente</button>
    </div>

    <hr>


    <div id="zapatosContainer"></div>
    <button type="button" onclick="agregarZapato()">âž• Agregar Articulo</button>

    <hr>

    <div class="form-group form-row">
        <div class="form-item">
            <label class="form-label">Tipo de pago</label>
            <select name="tipo_pago" id="tipo_pago" onchange="validarFormulario(); actualizarTotal()">
                <option value="">-- Selecciona --</option>
                <option value="efectivo">Efectivo</option>
                <option value="tarjeta">Tarjeta</option>
            </select>
        </div>

        <div class="form-item">
            <label class="form-label">Â¿Prepago?</label>
            <select name="prepago" id="prepago" onchange="togglePrepago(); validarFormulario(); actualizarTotal()">
                <option value="">-- Selecciona --</option>
                <option value="si">SÃ­</option>
                <option value="no">No</option>
            </select>
        </div>

        <div class="form-item" id="montoPrepagoContainer" style="display:none;">
            <label class="form-label">Monto prepago</label>
                <input
                    type="number"
                    min="0"
                    step="0.01"
                    name="monto_prepago"
                    id="monto_prepago"
                    placeholder="0.00"
                    oninput="validarFormulario(); actualizarTotal()"
                >
            <div id="errorPrepago" style="color:red; font-size:0.9em; display:none;">
                El prepago no puede ser mayor al total ni menor a 0.
            </div>
        </div>


        <div class="form-item">
            <label class="form-label">Â¿Aplicar descuento?</label>
            <select
                name="aplica_descuento"
                id="aplica_descuento"
                onchange="toggleDescuento(); actualizarTotal()"
            >
                <option value="">-- Selecciona --</option>
                <option value="si">SÃ­</option>
                <option value="no">No</option>
            </select>
        </div>

        <div class="form-item" id="porcentajeDescuentoContainer" style="display:none;">
            <label class="form-label">Porcentaje de descuento</label>
                <input
                    type="number"
                    min="1"
                    max="100"
                    step="0.01"
                    name="porcentaje_descuento"
                    id="porcentaje_descuento"
                    placeholder="10"
                    oninput="validarFormulario(); actualizarTotal()"
                >
                <div id="errorDescuento" style="color:red; font-size:0.9em; display:none;">
                    El descuento debe estar entre 1% y 100%.
                </div>
        </div>


        <div class="form-item checkbox-item">
            <label class="form-label">Entrega</label>
            <label class="custom-checkbox">
                <input
                    type="checkbox"
                    id="entregaExpress"
                    name="entrega_express"
                    value="1"
                    onchange="actualizarTotal()"
                >
                <span class="checkmark"></span>
                Entrega Express (+$50)
            </label>
        </div>

    </div>
    
    <hr>
    <div class="form-group form-row total-row">
        <div id="totalVenta" class="total-amount">
            Total: $0.00
        </div>

        <button type="submit" id="btnCrear" disabled style="margin-left:auto;">
            Crear recibo
        </button>
    </div>

</form>

<script>
let contadorZapatos = 0;
let serviciosGlobales = [];
let zapatosCliente = [];
let selectActual = null; 


document.addEventListener("DOMContentLoaded", async () => {
    await cargarServicios();

    document.getElementById("buscarCliente").addEventListener("input", buscarClientes);
    document.getElementById("btnCambiarCliente").addEventListener("click", () => location.reload());
    document.getElementById("btnNuevoCliente").addEventListener("click", () => {
        document.getElementById("modalCliente").style.display = "block";
    });
    document.getElementById("formNuevoCliente").addEventListener("submit", crearCliente);
    document.getElementById("formNuevoZapato").addEventListener("submit", crearZapato);
});

async function buscarClientes() {
    const q = this.value.trim();
    const lista = document.getElementById("listaClientes");
    lista.innerHTML = "";
    if (q.length < 2) return;

    const res = await fetch(`/api/clientes?q=${q}`);
    const clientes = await res.json();

    clientes.forEach(c => {
        const item = document.createElement("div");
        item.className = "result-item";
        item.innerHTML = `
            <div class="result-name">${c.nombre} ${c.apellido}</div>
            <div class="result-action">Seleccionar â†’</div>
        `;
        item.onclick = () => seleccionarCliente(c);
        lista.appendChild(item);
    });
}

function seleccionarCliente(cliente) {
    document.getElementById("id_cliente").value = cliente.id_cliente;
    document.getElementById("clienteSeleccionado").innerText =
        `Cliente: ${cliente.nombre} ${cliente.apellido}`;

    document.getElementById("tituloNuevaVenta").style.display = "none";
    document.getElementById("busquedaCliente").style.display = "none";
    document.getElementById("listaClientes").innerHTML = "";
    document.getElementById("formVenta").style.display = "block";

    cargarZapatosCliente(cliente.id_cliente);
    validarFormulario();
}

function cerrarModalCliente() {
    document.getElementById("modalCliente").style.display = "none";
}

async function crearCliente(e) {
    e.preventDefault();
    const formData = new FormData(e.target);
    const res = await fetch("/api/clientes/crear", { method: "POST", body: formData });
    const cliente = await res.json();
    cerrarModalCliente();
    seleccionarCliente(cliente);
}

async function cargarServicios() {
    const res = await fetch("/api/servicios");
    serviciosGlobales = await res.json();
}

async function cargarZapatosCliente(idCliente) {
    const res = await fetch(`/api/clientes/${idCliente}/zapatos`);
    zapatosCliente = await res.json();
}

function agregarZapato() {
    const index = contadorZapatos;

    const div = document.createElement("div");
    div.className = "zapato-item";
    div.innerHTML = `
        <div class="zapato-header">
            <div class="zapato-titulo">ðŸ§¾ ArtÃ­culo ${index + 1}</div>
            <button type="button" class="btn-eliminar-zapato" onclick="eliminarZapato(this)">âœ•</button>
        </div>
        ${crearSelectZapatos(index)}
        ${crearSelectServicios(index)}
    `;

    document.getElementById("zapatosContainer").appendChild(div);
    contadorZapatos++;
    validarFormulario();
}

function eliminarZapato(btn) {
    btn.closest(".zapato-item").remove();
    renumerarArticulos();               
    validarFormulario();              
    actualizarTotal();                   
}


function renumerarArticulos() {
    document.querySelectorAll(".zapato-item").forEach((item, i) => {
        item.querySelector(".zapato-titulo").innerText = `ðŸ§¾ ArtÃ­culo ${i + 1}`;
    });
    contadorZapatos = document.querySelectorAll(".zapato-item").length;
}

function crearSelectZapatos(index) {
    let opciones = `<option value="">Selecciona zapato</option>
                    <option value="nuevo">âž• Registrar nuevo calzado</option>`;
    zapatosCliente.forEach(z => {
        opciones += `<option value="${z.id_zapato}">
            ${z.marca} / ${z.tipo} / ${z.material} / ${z.color_base}-${z.color_secundario}
        </option>`;
    });

    return `<select name="zapatos[${index}][id_zapato]" onchange="seleccionarZapato(this)">
        ${opciones}
    </select>`;
}

function crearSelectServicios(index) {
    let opciones = `<option value="">Selecciona servicio</option>`;
    serviciosGlobales.forEach(s => {
        opciones += `<option value="${s.id_servicio}">${s.nombre} ($${s.precio})</option>`;
    });

    return `<select name="zapatos[${index}][id_servicio]" onchange="validarFormulario(); actualizarTotal()">
        ${opciones}
    </select>`;
}

function seleccionarZapato(select) {
    if (select.value === "nuevo") {
        selectActual = select;
        document.getElementById("id_cliente_modal").value = document.getElementById("id_cliente").value;
        document.getElementById("modalZapato").style.display = "block";
    }
}

function cerrarModalZapato() {
    document.getElementById("modalZapato").style.display = "none";
    document.getElementById("formNuevoZapato").reset();
}

async function crearZapato(e) {
    e.preventDefault();

    const formData = new FormData(e.target);
    const res = await fetch("/api/zapatos/crear", { method: "POST", body: formData });
    const nuevoZapato = await res.json();

    zapatosCliente.push(nuevoZapato);

    if (selectActual) {
        selectActual.innerHTML = `
            <option value="">Selecciona zapato</option>
            <option value="nuevo">âž• Registrar nuevo calzado</option>
            ${zapatosCliente.map(z => `
                <option value="${z.id_zapato}" ${z.id_zapato == nuevoZapato.id_zapato ? "selected" : ""}>
                    ${z.marca} / ${z.tipo} / ${z.material} / ${z.color_base}-${z.color_secundario}
                </option>
            `).join("")}
        `;
        selectActual = null;
    }

    cerrarModalZapato();
    validarFormulario();
}

function togglePrepago() {
    const val = document.getElementById("prepago").value;
    document.getElementById("montoPrepagoContainer").style.display = val === "si" ? "block" : "none";
    validarFormulario();
}

function validarFormulario() {
    const cliente = document.getElementById("id_cliente").value;
    const tipoPago = document.getElementById("tipo_pago").value;
    const prepago = document.getElementById("prepago").value;
    const monto = parseFloat(document.getElementById("monto_prepago")?.value || 0);

    let valido = cliente && tipoPago && prepago;

    const selects = document.querySelectorAll("#zapatosContainer select");
    if (selects.length === 0) valido = false;
    selects.forEach(s => { if (!s.value) valido = false; });

    let total = 0;
    document.querySelectorAll("#zapatosContainer select[name$='[id_servicio]']").forEach(select => {
        const idServicio = select.value;
        if (idServicio) {
            const servicio = serviciosGlobales.find(s => s.id_servicio == idServicio);
            if (servicio) total += parseFloat(servicio.precio);
        }
    });

    if (prepago === "si") {
        if (!monto || monto <= 0) valido = false;
        if (monto > total) document.getElementById("errorPrepago").style.display = "block";
        else document.getElementById("errorPrepago").style.display = "none";
    } else {
        document.getElementById("errorPrepago").style.display = "none";
    }

    document.getElementById("btnCrear").disabled = !valido;
}

function toggleDescuento() {
    const val = document.getElementById("aplica_descuento").value;
    document.getElementById("porcentajeDescuentoContainer").style.display =
        val === "si" ? "block" : "none";
}


function actualizarTotal() {
    let total = 0;

    document.querySelectorAll("#zapatosContainer select[name$='[id_servicio]']").forEach(select => {
        const idServicio = select.value;
        if (idServicio) {
            const servicio = serviciosGlobales.find(s => s.id_servicio == idServicio);
            if (servicio) total += parseFloat(servicio.precio);
        }
    });

    if (document.getElementById("entregaExpress").checked) {
        total += 50;
    }

    const aplicaDescuento = document.getElementById("aplica_descuento")?.value === "si";
    const porcentaje = parseFloat(document.getElementById("porcentaje_descuento")?.value || 0);

    if (aplicaDescuento && porcentaje > 0) {
        const descuento = total * (porcentaje / 100);
        total -= descuento;
    }

    document.getElementById("totalVenta").innerText =
        `Total: $${total.toFixed(2)}`;
}

const aplicaDescuento = document.getElementById("aplica_descuento").value === "si";
const porcentaje = parseFloat(document.getElementById("porcentaje_descuento")?.value || 0);


</script>


{% endblock %}
