{% extends "base.html" %}
{% block content %}

<h1>üßæ Entregas pendientes</h1>

{% if ventas %}
<div style="margin-bottom: 20px;">
    <input type="text" id="buscador-cliente" placeholder="Buscar por nombre del cliente..." 
           style="padding:5px 10px; width:250px; border-radius:5px; border:1px solid #ccc;">
</div>

{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    {% for category, message in messages %}
      <div class="alert {{ category }}">
        {{ message }}
      </div>
    {% endfor %}
  {% endif %}
{% endwith %}

<table border="1" id="tabla-ventas">
    <thead>
        <tr>
            <th>Recibo</th>
            <th>Cliente</th>
            <th>Fecha</th>
            <th>Prepago</th>
            <th>Total</th>
            <th>Monto prepago</th>
            <th>Pago a deber</th>
            <th>Detalles</th>
            <th>Acci√≥n</th>
        </tr>
    </thead>
    <tbody>
    {% for v in ventas %}
        {% set total = v.total | float(0) %}
        {% set prepago = v.monto_prepago | float(0) %}
        {% set deuda = total - prepago %}
        <tr>
            <td>#{{ v.id_venta }}</td>
            <td>{{ v.nombre }} {{ v.apellido }}</td>
            <td>{{ v.fecha_recibo }}</td>
            <td>{{ 'S√≠' if v.prepago else 'No' }}</td>
            <td>${{ total | round(2) }}</td>
            <td>${{ prepago | round(2) }}</td>
            <td>${{ deuda | round(2) }}</td>
            <td>
                <button class="btn-info" data-id="{{ v.id_venta }}">‚ÑπÔ∏è Info</button>
            </td>
            <td>
                <a href="/ventas/entregar/{{ v.id_venta }}"
                   onclick="return confirm('¬øMarcar como entregada?')"
                   class="btn-entregar"
                >
                   ‚úÖ Entregar
                </a>
            </td>
        </tr>
        <tr id="detalles-{{ v.id_venta }}" class="detalles-venta" style="display:none;">
            <td colspan="9">
                <div class="detalles-box">
                    <div class="detalles-title">üßæ Detalles de la venta</div>
                    <ul class="detalles-list">
                        {% for item in v.detalles %}
                            <li class="detalle-item">
                                <div class="detalle-zapato">
                                    üëü {{ item.zapato.tipo }} {{ item.zapato.marca }}
                                    <span class="detalle-color">
                                        {{ item.zapato.color_base }}{% if item.zapato.color_secundario %}/{{ item.zapato.color_secundario }}{% endif %}
                                    </span>
                                </div>
                                <div class="detalle-servicio">
                                    {{ item.servicio.nombre }}
                                    <span class="detalle-precio">
                                        ${{ "{:.2f}".format(item.servicio.precio) }}
                                    </span>
                                </div>
                            </li>
                        {% endfor %}
                    </ul>
                </div>
            </td>
        </tr>
    {% endfor %}
    </tbody>
</table>

{% else %}
<div style="
    margin-top:30px;
    padding:20px;
    text-align:center;
    font-size:1.2rem;
    font-weight:bold;
    background-color:#2fa4ff;
    color:#ffffff;
    border:1px solid #ffffff;
    border-radius:10px;
">
    üéâ No hay entregas pendientes por cobrar
</div>
{% endif %}

<script>
document.addEventListener("DOMContentLoaded", () => {
    // Toggle detalles
    function toggleDetalles(idVenta) {
        const fila = document.getElementById(`detalles-${idVenta}`);
        fila.style.display = fila.style.display === "none" ? "table-row" : "none";
    }

    document.querySelectorAll('.btn-info').forEach(btn => {
        btn.addEventListener('click', () => {
            toggleDetalles(btn.dataset.id);
        });
    });

    // Buscador por cliente
    const inputBuscador = document.getElementById('buscador-cliente');
    inputBuscador.addEventListener('keyup', () => {
        const filtro = inputBuscador.value.toLowerCase();
        const filas = document.querySelectorAll('#tabla-ventas tbody tr');

        filas.forEach(fila => {
            // Solo filas de ventas, no filas de detalles
            if (!fila.classList.contains('detalles-venta')) {
                const nombreCliente = fila.cells[1].textContent.toLowerCase();
                fila.style.display = nombreCliente.includes(filtro) ? '' : 'none';

                // Ocultar fila de detalles asociada tambi√©n
                const idVenta = fila.querySelector('.btn-info').dataset.id;
                const filaDetalle = document.getElementById(`detalles-${idVenta}`);
                if (filaDetalle) {
                    filaDetalle.style.display = 'none';
                }
            }
        });
    });
});
</script>

{% endblock %}
