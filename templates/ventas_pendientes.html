{% extends "base.html" %}
{% block content %}
{% from "macros/badges.html" import badge_negocio %}


<h1>üßæ Entregas pendientes</h1>

{% if ventas %}
<div style="margin-bottom: 20px; display:flex; gap:10px; align-items:center;">

    <input type="text" id="buscador-cliente" 
           placeholder="üîç Buscar cliente..."
           style="padding:6px 10px; width:250px; border-radius:5px; border:1px solid #ccc;">

    <select id="filtro-negocio"
            style="padding:6px 10px; border-radius:5px; border:1px solid #ccc;">
        <option value="">Todos los negocios</option>
        {% for n in negocios %}
            <option value="{{ n.nombre | lower }}">
                {{ n.nombre }}
            </option>
        {% endfor %}
    </select>

</div>


{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    {% for category, message in messages %}
      <div class="alert {{ category }}">
        {{ message }}
      </div>
    {% endfor %}
  {% endif %}
{% endwith %}

<style>
.entrega-hoy {
    background-color: #fff3cd;  
}
</style>

<table border="1" id="tabla-ventas">
    <thead>
        <tr>
            <th>Recibo</th>
            <th>Negocio</th>
            <th>Cliente</th>
            <th>Fecha</th>
            <th>Fecha estimada</th>
            <th>Prepago</th>
            <th>Total</th>
            <th>Monto prepago</th>
            <th>Pago a deber</th>
            <th>Detalles</th>
            <th>Acci√≥n</th>
        </tr>
    </thead>
    <tbody>
    {% set meses = {
        1:'enero', 2:'febrero', 3:'marzo', 4:'abril',
        5:'mayo', 6:'junio', 7:'julio', 8:'agosto',
        9:'septiembre', 10:'octubre', 11:'noviembre', 12:'diciembre'
        } %}
    {% for v in ventas %}
        {% set total = v.total | float(0) %}
        {% set prepago = v.monto_prepago | float(0) %}
        {% set deuda = total - prepago %}

        <tr class="{% if v.fecha_estimada.date() < hoy %}entrega-atrasada{% elif v.fecha_estimada.date() == hoy %}entrega-hoy{% endif %}">
            <td>#{{ v.id_venta }}</td>
            <td>{{ badge_negocio(v.negocio) }}</td>
            <td>{{ v.nombre }} {{ v.apellido }}</td>
            <td>
                {{ v.fecha_recibo.day }} {{ meses[v.fecha_recibo.month] }}
                {{ "%02d:%02d"|format(v.fecha_recibo.hour, v.fecha_recibo.minute) }}
            </td>

            <td>
                {{ v.fecha_estimada.day }} {{ meses[v.fecha_estimada.month] }}
                {{ "%02d:%02d"|format(v.fecha_estimada.hour, v.fecha_estimada.minute) }}

                {% if v.fecha_estimada.date() < hoy %}
                    <span class="badge-atrasado">ATRASADO</span>
                {% elif v.fecha_estimada.date() == hoy %}
                    <span class="badge-hoy">HOY</span>
                {% endif %}
            </td>
            <td>{{ 'S√≠' if v.prepago else 'No' }}</td>
            <td>${{ total | round(2) }}</td>
            <td>${{ prepago | round(2) }}</td>
            <td>${{ deuda | round(2) }}</td>
            <td>
                <button class="btn-info" data-id="{{ v.id_venta }}">‚ÑπÔ∏è Info</button>
            </td>
            <td>
                <a href="/ventas/entregar/{{ v.id_venta }}"
                   onclick="return confirm('¬øMarcar como entregada?')"
                   class="btn-entregar"
                >
                   ‚úÖ Entregar
                </a>
            </td>
        </tr>

        <tr id="detalles-{{ v.id_venta }}" class="detalles-venta" style="display:none;">
            <td colspan="11">
                <div class="detalles-box">
                    <div class="detalles-title">üßæ Detalles de la venta</div>

                    <ul class="detalles-list">
                        {% for item in v.detalles %}
                            <li class="detalle-item">

                                {% if item.tipo_articulo == "calzado" %}
                                    <div class="detalle-zapato">
                                        üëü {{ item.datos.tipo }} {{ item.datos.marca }}
                                        <span class="detalle-color">
                                            {{ item.datos.color_base }}
                                            {% if item.datos.color_secundario %}/{{ item.datos.color_secundario }}{% endif %}
                                        </span>
                                    </div>

                                    {% for s in item.servicios %}
                                        <div class="detalle-servicio">
                                            {{ s.nombre }}
                                            <span class="detalle-precio">
                                                ${{ "{:.2f}".format(s.precio_aplicado) }}
                                            </span>
                                        </div>
                                    {% endfor %}

                                {% elif item.tipo_articulo == "confeccion" %}
                                    <div class="detalle-zapato">
                                        üßµ {{ item.datos.tipo }} {{ item.datos.marca }}
                                        <span class="detalle-color">
                                            {{ item.datos.color_base }}
                                            {% if item.datos.color_secundario %}/{{ item.datos.color_secundario }}{% endif %}
                                        </span>
                                    </div>

                                    <div style="margin-top:4px;">
                                        Cantidad: <b>{{ item.datos.cantidad }}</b> 
                                    </div>

                                    {% for s in item.servicios %}
                                        <div class="detalle-servicio">
                                            {{ s.nombre }}
                                            <span class="detalle-precio">
                                                ${{ "{:.2f}".format(s.precio_aplicado) }}
                                            </span>
                                        </div>
                                    {% endfor %}

                                {% elif item.tipo_articulo == "maquila" %}
                                    <div class="detalle-zapato">
                                        üè≠ {{ item.datos.tipo }}
                                    </div>
                                    <div style="margin-top:4px;">
                                        Cantidad: <b>{{ item.datos.cantidad }}</b> |
                                        Precio unitario: <b>${{ "{:.2f}".format(item.datos.precio_unitario) }}</b>
                                    </div>
                                {% endif %}

                                {% if item.comentario %}
                                    <div style="margin-top:6px; font-style:italic; opacity:0.8;">
                                        üí¨ {{ item.comentario }}
                                    </div>
                                {% endif %}

                            </li>
                        {% endfor %}
                    </ul>

                </div>
            </td>
        </tr>
    {% endfor %}
    </tbody>
</table>

{% else %}
<div style="
    margin-top:30px;
    padding:20px;
    text-align:center;
    font-size:1.2rem;
    font-weight:bold;
    background-color:#2fa4ff;
    color:#ffffff;
    border:1px solid #ffffff;
    border-radius:10px;
">
    üéâ No hay entregas pendientes
</div>
{% endif %}

<script>
document.addEventListener("DOMContentLoaded", () => {

    function toggleDetalles(idVenta) {
        const fila = document.getElementById(`detalles-${idVenta}`);
        fila.style.display = fila.style.display === "none" ? "table-row" : "none";
    }

    document.querySelectorAll('.btn-info').forEach(btn => {
        btn.addEventListener('click', () => {
            toggleDetalles(btn.dataset.id);
        });
    });

    const inputBuscador = document.getElementById('buscador-cliente');
    const selectNegocio  = document.getElementById('filtro-negocio');

    function aplicarFiltros() {
        const filtroNombre  = inputBuscador.value.toLowerCase();
        const filtroNegocio = selectNegocio.value.toLowerCase();

        const filas = document.querySelectorAll('#tabla-ventas tbody tr');

        filas.forEach(fila => {
            if (!fila.classList.contains('detalles-venta')) {

                const nombreCliente = fila.cells[2].textContent.toLowerCase(); 
                const negocio       = fila.cells[1].textContent.toLowerCase();

                const coincideNombre  = nombreCliente.includes(filtroNombre);
                const coincideNegocio = filtroNegocio === "" || negocio.includes(filtroNegocio);

                const mostrar = coincideNombre && coincideNegocio;
                fila.style.display = mostrar ? '' : 'none';

                const btnInfo = fila.querySelector('.btn-info');
                if (btnInfo) {
                    const idVenta = btnInfo.dataset.id;
                    const filaDetalle = document.getElementById(`detalles-${idVenta}`);
                    if (filaDetalle) {
                        filaDetalle.style.display = 'none';
                    }
                }
            }
        });
    }

    inputBuscador.addEventListener('keyup', aplicarFiltros);
    selectNegocio.addEventListener('change', aplicarFiltros);

});
</script>


{% endblock %}
