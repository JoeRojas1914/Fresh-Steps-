{% extends "base.html" %}
{% block content %}

<h1>üßæ Entregas pendientes</h1>

{% if ventas %}
<div style="margin-bottom: 20px;">
    <input type="text" id="buscador-cliente" placeholder="Buscar por nombre del cliente..."
           style="padding:5px 10px; width:250px; border-radius:5px; border:1px solid #ccc;">
</div>

{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    {% for category, message in messages %}
      <div class="alert {{ category }}">
        {{ message }}
      </div>
    {% endfor %}
  {% endif %}
{% endwith %}

<style>
.entrega-hoy {
    background-color: #fff3cd;  
}
</style>

<table border="1" id="tabla-ventas">
    <thead>
        <tr>
            <th>Recibo</th>
            <th>Negocio</th>
            <th>Cliente</th>
            <th>Fecha</th>
            <th>Fecha estimada</th>
            <th>Prepago</th>
            <th>Total</th>
            <th>Monto prepago</th>
            <th>Pago a deber</th>
            <th>Detalles</th>
            <th>Acci√≥n</th>
        </tr>
    </thead>
    <tbody>
    {% for v in ventas %}
        {% set total = v.total | float(0) %}
        {% set prepago = v.monto_prepago | float(0) %}
        {% set deuda = total - prepago %}

        <tr class="{% if v.fecha_estimada == hoy %}entrega-hoy{% endif %}">
            <td>#{{ v.id_venta }}</td>
            <td>{{ v.negocio or "-" }}</td>
            <td>{{ v.nombre }} {{ v.apellido }}</td>
            <td>{{ v.fecha_recibo }}</td>
            <td>{{ v.fecha_estimada }}</td>
            <td>{{ 'S√≠' if v.prepago else 'No' }}</td>
            <td>${{ total | round(2) }}</td>
            <td>${{ prepago | round(2) }}</td>
            <td>${{ deuda | round(2) }}</td>
            <td>
                <button class="btn-info" data-id="{{ v.id_venta }}">‚ÑπÔ∏è Info</button>
            </td>
            <td>
                <a href="/ventas/entregar/{{ v.id_venta }}"
                   onclick="return confirm('¬øMarcar como entregada?')"
                   class="btn-entregar"
                >
                   ‚úÖ Entregar
                </a>
            </td>
        </tr>

        <tr id="detalles-{{ v.id_venta }}" class="detalles-venta" style="display:none;">
            <td colspan="11">
                <div class="detalles-box">
                    <div class="detalles-title">üßæ Detalles de la venta</div>

                    <ul class="detalles-list">
                        {% for item in v.detalles %}
                            <li class="detalle-item">

                                {% if item.tipo_articulo == "calzado" %}
                                    <div class="detalle-zapato">
                                        üëü {{ item.datos.tipo }} {{ item.datos.marca }}
                                        <span class="detalle-color">
                                            {{ item.datos.color_base }}
                                            {% if item.datos.color_secundario %}/{{ item.datos.color_secundario }}{% endif %}
                                        </span>
                                    </div>

                                    {% for s in item.servicios %}
                                        <div class="detalle-servicio">
                                            {{ s.nombre }}
                                            <span class="detalle-precio">
                                                ${{ "{:.2f}".format(s.precio_aplicado) }}
                                            </span>
                                        </div>
                                    {% endfor %}

                                {% elif item.tipo_articulo == "confeccion" %}
                                    <div class="detalle-zapato">
                                        üßµ {{ item.datos.tipo }} {{ item.datos.marca }}
                                        <span class="detalle-color">
                                            {{ item.datos.color_base }}
                                            {% if item.datos.color_secundario %}/{{ item.datos.color_secundario }}{% endif %}
                                        </span>
                                    </div>

                                    <div style="margin-top:4px;">
                                        Cantidad: <b>{{ item.datos.cantidad }}</b> 
                                    </div>

                                    {% for s in item.servicios %}
                                        <div class="detalle-servicio">
                                            {{ s.nombre }}
                                            <span class="detalle-precio">
                                                ${{ "{:.2f}".format(s.precio_aplicado) }}
                                            </span>
                                        </div>
                                    {% endfor %}

                                {% elif item.tipo_articulo == "maquila" %}
                                    <div class="detalle-zapato">
                                        üè≠ {{ item.datos.tipo }}
                                    </div>
                                    <div style="margin-top:4px;">
                                        Cantidad: <b>{{ item.datos.cantidad }}</b> |
                                        Precio unitario: <b>${{ "{:.2f}".format(item.datos.precio_unitario) }}</b>
                                    </div>
                                {% endif %}

                                {% if item.comentario %}
                                    <div style="margin-top:6px; font-style:italic; opacity:0.8;">
                                        üí¨ {{ item.comentario }}
                                    </div>
                                {% endif %}

                            </li>
                        {% endfor %}
                    </ul>

                </div>
            </td>
        </tr>
    {% endfor %}
    </tbody>
</table>

{% else %}
<div style="
    margin-top:30px;
    padding:20px;
    text-align:center;
    font-size:1.2rem;
    font-weight:bold;
    background-color:#2fa4ff;
    color:#ffffff;
    border:1px solid #ffffff;
    border-radius:10px;
">
    üéâ No hay entregas pendientes
</div>
{% endif %}

<script>
document.addEventListener("DOMContentLoaded", () => {
    function toggleDetalles(idVenta) {
        const fila = document.getElementById(`detalles-${idVenta}`);
        fila.style.display = fila.style.display === "none" ? "table-row" : "none";
    }

    document.querySelectorAll('.btn-info').forEach(btn => {
        btn.addEventListener('click', () => {
            toggleDetalles(btn.dataset.id);
        });
    });

    const inputBuscador = document.getElementById('buscador-cliente');
    inputBuscador.addEventListener('keyup', () => {
        const filtro = inputBuscador.value.toLowerCase();
        const filas = document.querySelectorAll('#tabla-ventas tbody tr');

        filas.forEach(fila => {
            if (!fila.classList.contains('detalles-venta')) {
                const nombreCliente = fila.cells[2].textContent.toLowerCase(); 
                fila.style.display = nombreCliente.includes(filtro) ? '' : 'none';

                const btnInfo = fila.querySelector('.btn-info');
                if (btnInfo) {
                    const idVenta = btnInfo.dataset.id;
                    const filaDetalle = document.getElementById(`detalles-${idVenta}`);
                    if (filaDetalle) {
                        filaDetalle.style.display = 'none';
                    }
                }
            }
        });
    });
});
</script>

{% endblock %}
